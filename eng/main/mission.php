<?php  require_once('lib/dbo.php');  require_once('lib/object.php');  require_once('lib/data.php');  require_once('lib/defines.php');  require_once('eng/main/troop.php');  class Mission  {   public function SetMission()   {    global $account;    $town = $account->GetDefaultTown();    global $dbo;    global $lang;          global $troops;    if(!$town->Lock())     return;    switch($account->training)    {     case 0:      if($town->b5)                      $this->SetTraining(1);      $dbo->ExectueQuery(sprintf('UPDATE `%sbuilding_q` SET `modify` = \'%s\' WHERE `tid` = \'%s\' AND `bid` = \'5\'',       DB_PERFIX,$town->modify,$town->id));      if($dbo->AffectedRows())       $this->SetTraining(1);      break;     case 1:      if($town->u4)      {       $town->AddResource(50,50,50,50,50);       $this->SetTraining(2);      }      break;     case 2:      if($town->u1 and $town->u2 and $town->u3 and $town->u4 and $town->u5)      {       $town->AddResource(100,100,100,100,100);       $this->SetTraining(3);      }      break;     case 3:      if($town->GetName($town->id) != $lang['NewTown'])      {       $this->AddTalant(10);       $this->SetTraining(4);       }      break;     case 4:      if($town->GetLevel(7) >= 1)      {       $town->AddResource(115,115,115,115,115);       $this->SetTraining(5);      }      break;     case 5:      if($town->GetLevel(8) >= 1)      {       $this->SetTraining(6);       break;      }      $id = 0;      for($i=7;$i<26;$i++)      {       $b = 'b'.$i;       if($town->$b == 8)       {        $id = $i;        break;       }      }      if($id)      {       $dbo->ExectueQuery(sprintf('UPDATE `%sbuilding_q` SET `modify` = \'%s\' WHERE `tid` = \'%s\' AND `bid` = \'%s\'',        DB_PERFIX,$town->modify,$town->id,$id));       if($dbo->AffectedRows())        $this->SetTraining(6);      }      break;     case 6:      if($_SERVER['PHP_SELF'] == '/hero.php')      {       $town->AddResource(45,45,45,45,45);       $this->SetTraining(7);      }      break;     case 7:      if($town->u6 >=3)      {       $m = $_SERVER['REQUEST_TIME'] + (24*ONE_TICK);       if($account->pb > $_SERVER['REQUEST_TIME'])        $m = $account->pb + (24*ONE_TICK);       $account->SetFields(array('pb' => $m));       $this->SetTraining(8);      }      break;     case 8:      if($_SERVER['PHP_SELF'] == '/plus.php')      {       $town->AddResource(100,100,100,100,100);       $this->SetTraining(9);      }      break;     case 9:      if( ($town->u1 >= 2) and ($town->u2  >= 2) and ($town->u3 >= 2) and ($town->u4 >= 2) and ($town->u5 >= 2))      {       $town->AddResource(200,200,200,200,200);       $this->SetTraining(10);      }      break;              case 10:                    if($dbo->ExectueScaler(                      sprintf('SELECT COUNT(*) AS `c` FROM `%splus` WHERE `pid` = \'%s\' AND `kind` = \'%s\' AND `modify`  >= \'%s\'',                          DB_PERFIX, $account->id, EXCHANGE_PLUS, Today($_SERVER['REQUEST_TIME'])),'c'))                  {                      $town->AddResource(500,500,500,500,500);                      $this->SetTraining(11);                  }       case 11:      if($town->GetLevel(28) >0)      {       $town->AddResource(0,0,0,50,50);       $this->SetTraining(12);      }      break;     case 12:      if( $town->w1 > 2 or $town->w2  > 2 or $town->w3 > 2 or $town->w4 > 2 or $town->w5 > 2)      {       $town->AddResource(275,275,275,275,275);       $this->SetTraining(13);      }      break;     case 13:      if($_SERVER['PHP_SELF'] == '/map.php')      {       $town->AddResource(200,200,200,200,200);       $this->SetTraining(14);      }      break;     case 14:      if($town->GetLevel(10) >0)      {       $town->AddResource(165,165,165,165,165);       $this->SetTraining(15);       $arr = array();       $arr['flag'] = SYS_INFO|NOT_READ;       $arr['se'] = '1';       $arr['re'] = $account->id;       $arr['modify'] = $_SERVER['REQUEST_TIME'];       $arr['subject'] = $lang['NewPm'];       $arr['message'] = $lang['WellCome'];       $dbo->InsertRow(DB_PERFIX.'pm',$arr);      }      break;     case 15:      if($town->GetLevel(19) >0)      {       $town->AddResource(125,125,125,125,125);       $this->SetTraining(16);      }      break;     case 16:      if($account->adv >= $_SERVER['REQUEST_TIME'] - (24*ONE_TICK))      {       $this->AddMap($account->id);       $this->SetTraining(17);      }      break;     case 17:      if($town->GetLevel(11) >0)      {       $town->AddFields(array('t1'=>3,'used' => 3 * $troops[$account->kind][1][8]));       $this->SetTraining(18);      }      break;     case 18:      if($town->GetLevel(9) >0)      {       $town->AddResource(0,245,245,0,0);       $this->SetTraining(19);      }      break;     case 19:      if($town->GetLevel(18) >0)      {       $town->AddResource(75,75,75,75,75);       $this->SetTraining(20);      }      break;     case 20:      if($town->GetLevel(12) >0)      {       $town->AddFields(array('t3'=>'3','used' => 3 * $troops[$account->kind][3][8]));       $this->SetTraining(21);      }      break;         case 21:      if($_SERVER['PHP_SELF'] == '/statistics.php')      {       $town->AddResource(300,0,0,0,0);       $this->SetTraining(22);      }      break;     case 22:      if($town->GetLevel(24) >0)      {       $this->AddTalant(5);       $this->SetTraining(23);      }      break;              case 23:                  $town->AddResource(1000,1000,1000,1000,1000);                  $this->SetTraining(24);                  break;    }    $town->UnLock();    unset($town);   }   protected function AddMap($id)   {    global $dbo;    $t = $dbo->ExectueRow(sprintf('SELECT * FROM `%sserver_info` WHERE `com` = \'%s\'',DB_PERFIX,HERO_ITEM_FREE));    $brr = array();    $brr['pid'] = $id;    $brr['lvl'] = '1';    $brr['r'] =  '50';    $dbo->InsertRow(DB_PERFIX.'hero_tm',$brr);    $brr = array('tid' => $dbo->InsertedID());    $brr['hid'] = mt_rand($t['kind'], $t['subkind']);    $dbo->InsertRow(DB_PERFIX.'hero_tmi', $brr);   }   protected function AddTalant($n)   {    global $account;    global $dbo;    $account->SetFields(array('t_b' =>$n));    $arr = array();    $arr['pid'] = $account->id;    $arr['cost'] = $n;    $arr['kind'] = TRANING_PLUS;    $arr['subkind'] = '0';    $arr['types'] = SPEND;    $arr['modify'] = $_SERVER['REQUEST_TIME'];    $dbo->InsertRow(sprintf('%splus',DB_PERFIX), $arr);   }   public function SetTraining($mid)   {    global $account;    $account->SetFields(array('training'=>$mid));   }      public function GetTraining()      {          global $account;          $town = $account->GetDefaultTown();          global $dbo;          global $lang;          $complete = false;          switch($account->training)          {              case 0:                  if($town->b5)                      $complete = true;                  break;              case 1:                  if($town->u4)                      $complete = true;                  break;              case 2:                  if($town->u1 and $town->u2 and $town->u3 and $town->u4 and $town->u5)                      $complete = true;                  break;              case 3:                  if($town->name != $lang['NewTown'])                      $complete = true;                  break;              case 4:                  if($town->GetLevel(7) >= 1)                      $complete = true;                  break;              case 5:                  if($town->GetLevel(8) >= 1)                  {                      $complete = true;                      break;                  }                  for($i=7;$i<26;$i++)                  {                      $b = 'b'.$i;                      if($town->$b == 8)                      {                          $complete = true;                          break;                      }                  }                  break;              case 7:                  if($town->u6 >=3)                      $complete = true;                  break;              case 8:                  if($_SERVER['PHP_SELF'] == '/plus.php')                      $complete = true;                  break;              case 9:                  if( ($town->u1 >= 2) and ($town->u2  >= 2) and ($town->u3 >= 2) and ($town->u4 >= 2) and ($town->u5 >= 2))                      $complete = true;                  break;              case 10:                  var_dump(printf('SELECT COUNT(*) AS `c` FROM `%splus` WHERE `pid` = \'%s\' AND `kind` = \'%s\' AND `modify`  >= \'%s\'',                      DB_PERFIX, $account->id, EXCHANGE_PLUS, Today($_SERVER['REQUEST_TIME'])));                  if($dbo->ExectueScaler(                      sprintf('SELECT COUNT(*) AS `c` FROM `%splus` WHERE `pid` = \'%s\' AND `kind` = \'%s\' AND `modify`  >= \'%s\'',                      DB_PERFIX, $account->id, EXCHANGE_PLUS, Today($_SERVER['REQUEST_TIME'])),'c') > 0)                      $complete = true;                  break;              case 11:                  if($town->GetLevel(28) >0)                      $complete = true;                  break;              case 12:                  if( $town->w1 > 2 or $town->w2  > 2 or $town->w3 > 2 or $town->w4 > 2 or $town->w5 > 2)                      $complete = true;                  break;              case 13:                  if($_SERVER['PHP_SELF'] == '/map.php')                      $complete = true;                  break;              case 14:                  if($town->GetLevel(10) >0)                      $complete = true;                  break;              case 15:                  if($town->GetLevel(19) >0)                      $complete = true;                  break;              case 16:                  if($account->adv >= $_SERVER['REQUEST_TIME'] - (24*ONE_TICK))                      $complete = true;                  break;              case 17:                  if($town->GetLevel(11) >0)                      $complete = true;                  break;              case 18:                  if($town->GetLevel(9) >0)                      $complete = true;                  break;              case 19:                  if($town->GetLevel(18) >0)                      $complete = true;                  break;              case 20:                  if($town->GetLevel(12) >0)                      $complete = true;                  break;              case 22:                  if($town->GetLevel(24) >0)                      $complete = true;                  break;              case 23:                  $complete = true;                  break;          }          $com = $dbo->ExectueRow(sprintf('SELECT * FROM `%smission` WHERE `id` = \'%s\'',DB_PERFIX,$account->training + 1));          if($complete)              $com['com'] = sprintf('<div style="width: 398px;">%s<br /><br /><form action="town.php" method="post"><input type="hidden" name = "com" value="sm" /><center><input type="submit" value="%s" /></center></form></div></div>',                  $com['com'], $lang['Save']);          else              $com['com'] = sprintf('<div style="width: 398px;">%s</div>',$com['com']);          return $com;      }  }  $mission = new Mission();  ?>
<?php  require_once('lib/config.php');  require_once('lib/dbo.php');  require_once('lib/defines.php');  class Report  {   public function GetUnionReport($id,$kind = true)   {    global $dbo;    $list = array();    return $list;   }   public function &GetAttacks($mid, $pid)   {    $list = array();    global $dbo;    $i =0;    $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM `%sreports` WHERE `pid` = \'%s\' AND `mid` = \'%s\' AND `kind` != \'%s\' LIMIT 0, 5',      DB_PERFIX, $pid, RE_TRADE));    while($row = $dbo->Read($sql))     $list[$i++] = $row;    gc_collect_cycles();    return $list;   }   public function AddMarketReport(&$row, $mid1, $mid2, $blockage)   {    global $dbo;    $arr = array();    $res = array(     (int)floor($row['r1'] * ($blockage ? 0.8 : 1)),     (int)floor($row['r2'] * ($blockage ? 0.8 : 1)),     (int)floor($row['r3'] * ($blockage ? 0.8 : 1)),     (int)floor($row['r4'] * ($blockage ? 0.8 : 1)),     (int)floor($row['r5'] * ($blockage ? 0.8 : 1)));    $arr['pid1'] = $row['pid1'];    $arr['pid2'] = $row['pid2'];    $arr['pid'] = $row['pid1'];    $arr['kind'] = RE_TRADE;    $arr['mid'] = $mid2;    $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,     $row['pid1'],$row['tid1'],$mid1,     $row['pid2'],$row['tid2'],$mid2, 0);    $arr['data'] .= RE_RESOURCE.':'.implode(':',$res);    $arr['l'] = $blockage ? RE_LOSSES : RE_WIN;    $arr['modify'] = $row['modify'];    $dbo->InsertRow(DB_PERFIX.'reports',$arr);    $arr['pid'] = $row['pid2'];    $dbo->InsertRow(DB_PERFIX.'reports',$arr);   }   public function NewTown($pid, $mid1, $tid1, $mid2, $tid2,$modify)   {    global $dbo;    $arr = array();    $arr['pid1'] = $pid;    $arr['pid'] = $pid;    $arr['kind'] = RE_ATTACK;    $row['mid'] = $mid1;    $arr['l'] = RE_WIN;    $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:0,',RE_INFO,     $pid,$tid1,$mid1,     $pid,$tid2,$mid2);    $arr['data'] .= sprintf('%s:%s:%s:%s',RE_NEW_TOWN,$pid,$mid2,$tid2);    $arr['modify'] =  $modify;    $dbo->InsertRow(DB_PERFIX.'reports',$arr);   }   public function HeroAdventure($pid,$tid,$win, &$info,$modify)   {    global $dbo;    $arr = array();    $arr['pid'] =    $arr['pid1'] = $arr['pid1'] = $pid;    $arr['kind'] = RE_ADVENTURE;    $arr['l'] = $win;    $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:0,',RE_INFO,     $pid,$tid,0,     $pid,$tid,0,0);    $arr['data'] .= implode(',',$info);    $arr['modify'] =  $modify;    $dbo->InsertRow(DB_PERFIX.'reports',$arr);   }   public function Espial(&$row,$f1,$f2,&$t,&$e, $per1, $per2)   {    global $dbo;    $arr = array();    $arr['pid1'] = $row['pid1'];    $arr['pid2'] = $row['pid2'];    $arr['pid'] = $row['pid1'];    $arr['l'] = $f1;    $arr['kind'] = RE_ESPIAL;    $arr['mid'] = $row['mid2'];    $arr['flag'] = 0;    if($per1 & UNION_REPORT)     $arr['flag'] = $arr['flag'] | RE_UNI;    $temp = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,     $row['pid1'],$row['tid1'],$row['mid1'],     $row['pid2'],$row['tid2'],$row['mid2'],$row['cid']);    $temp  .= RE_ATTAKER_T.':'.$row['pid1'].':'.$row['tid1'].':'.implode(':',$t[-1]);    $arr['data'] = $temp;    $temp .= ','.RE_DEFENDANT_T.':'.$row['pid2'].':'.$row['tid2'].':'.implode(':',$t[0]);    for($i=1;$i<7;$i++)    {     if(isset($t[$i]))      $temp .= sprintf(',%s:0:0:%s',RE_SUPPORT_T,implode(':',$t[$i]));    }    if(count($e))     $temp.= ','.implode(',',$e);    foreach($e as $e1)    {     if($e1[0] == RE_ELIXIR_A)      $arr['data'] .= ','. $e1;    }    if($f1 != RE_DEFEAT)     $arr['data'] = $temp;    $arr['modify'] = $row['modify'];    $dbo->InsertRow(DB_PERFIX.'reports',$arr);    if($f2 != RE_NO_REPORT)    {     $arr['flag'] = 0;     if($per2 & UNION_REPORT)      $arr['flag'] = $arr['flag'] | RE_UNI;     $arr['pid'] = $row['pid2'];     $arr['l'] = $f2;     $arr['data'] = $temp;     $dbo->InsertRow(DB_PERFIX.'reports',$arr);    }    unset($arr);   }   public function LoadReport($id)   {    global $dbo;    return $dbo->ExectueRow(sprintf('SELECT * FROM `%sreports` WHERE `id` = \'%s\'',DB_PERFIX,$id));   }   public function SendElixir($pid1,$tid1,$mid1,$tid2, &$temp)   {    global $dbo;    $arr = array();    $row = $dbo->ExectueRow(sprintf('SELECT `pid`,`mid` FROM `%stown` WHERE `id` = \'%s\'',DB_PERFIX, $tid2));    $arr['pid'] = $pid1;    $arr['pid1'] = $pid1;    $arr['pid2'] = $row['pid'];    $arr['kind'] = RE_TRADE;    $arr['mid'] = $row['mid'];    $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:0',RE_INFO,     $pid1, $tid1, $mid1,      $row['pid'], $tid2, $row['mid']);    foreach($temp as $key=>$value)     $arr['data'] .= sprintf(',%s:%s:%s',RE_ELIXIR_A, $key, $value);    $arr['modify'] = $_SERVER['REQUEST_TIME'];    $dbo->InsertRow(DB_PERFIX.'reports',$arr);    $arr['pid'] = $row['pid'];    $dbo->InsertRow(DB_PERFIX.'reports',$arr);   }   public function SetFlag($id,$pid,$flag)   {    global $dbo;    $dbo->ExectueQuery(sprintf('UPDATE `%sreports` SET `flag` = `flag` | \'%u\' WHERE `id` = \'%s\' AND `pid` = \'%s\' LIMIT 1',     DB_PERFIX, $flag, $id, $pid));   }   public function GetNotRead($id)   {    global $dbo;    return $dbo->ExectueScaler(sprintf('SELECT COUNT(*) AS `c` FROM `%sreports` WHERE `pid` = \'%s\'  AND NOT (`flag` & \'%d\')',     DB_PERFIX,$id,RE_READ | RE_ARC | RE_DEL),'c');   }   public function RemoveFlag($id,$pid,$flag)   {   }   public function UnDeadAttack(&$t,$pid1,$pid2, $tid1,$tid2,$mid,$modify, $l1,$l2)   {    global $dbo;    $arr = array();    $arr['pid1'] = '7';    $arr['pid2'] = $pid2;    $arr['pid'] = $pid1;    $arr['l'] = $l1;    $arr['kind'] = RE_ATTACK;    $arr['mid'] = $mid;    $arr['flag'] = 0;    $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:0,',RE_INFO,     '7','7',0,     $pid2,$tid2,$mid);    $arr['data'] .= sprintf('%s:0,', RE_INFO);    $arr['data'] .= RE_ATTAKER_T.':7:7:'.implode(':',$t[-2]);    $arr['data'] .= ','.RE_ATTAKER_T.':'.$pid1.':'.$tid1.':'.implode(':',$t[-1]);    $arr['data'] .= ','.RE_DEFENDANT_T.':'.$pid2.':'.$tid2.':'.implode(':',$t[0]);    for($i=1;$i<7;$i++)    {     if(isset($t[$i]))      $arr['data'] .= sprintf(',%s:0:0:%s',RE_SUPPORT_T,implode(':',$t[$i]));    }    $arr['modify'] = $modify;    $dbo->InsertRow(DB_PERFIX.'reports',$arr);          $arr['pid'] = $pid2;          $arr['l'] = $l2;          $dbo->InsertRow(DB_PERFIX.'reports',$arr);    unset($arr);   }   public function Attack(&$t, $pid1, $pid2, $tid1, $tid2, $mid1, $mid2, $cid, $per1, $per2, $modify, $l1, $l2, $e)   {    global $dbo;    $arr = array();    $arr['pid1'] = $pid1;    $arr['pid2'] = $pid2;    $arr['pid'] = $pid1;    $arr['l'] = $l1 ;    $arr['kind'] = RE_ATTACK;    $arr['mid'] = $mid2;    $arr['flag'] = 0;    $temp2 = '';    if($per1 & UNION_REPORT)     $arr['flag'] = $arr['flag'] | RE_UNI;    $temp2 = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,     $pid1,$tid1,$mid1,     $pid2,$tid2,$mid2, $cid);    $temp2 .= RE_ATTAKER_T.':'.$pid1.':'.$tid1.':'.implode(':',$t[-1]);    $arr['data'] = $temp2;    $temp = ','.RE_DEFENDANT_T.':'.$pid2.':'.$tid2.':'.implode(':',$t[0]);    for($i = 1; $i < 7; $i++)    {     if(isset($t[$i]))      $temp .= sprintf(',%s:0:0:%s',RE_SUPPORT_T,implode(':',$t[$i]));    }        if(count($e))     $temp .= ','.implode(',',$e);    if($l1 != RE_DEFEAT)     $arr['data'] .= $temp;    $arr['modify'] = $modify;    if($pid1 > 7)     $dbo->InsertRow(DB_PERFIX.'reports',$arr);    $arr['data'] = $temp2.$temp;    $arr['flag'] = 0;    if($per2 & UNION_REPORT)     $arr['flag'] = $arr['flag'] | RE_UNI;    $arr['pid'] = $pid2;    $arr['l'] = $l2;    if($pid2 > 7)     $dbo->InsertRow(DB_PERFIX.'reports',$arr);   }   public function Support(&$row,$temp)   {    global $dbo;    $arr = array();    $arr['pid'] = $row['pid1'];    $arr['pid1'] = $row['pid1'];    $arr['pid2'] = $row['pid2'];    $arr['kind'] = RE_SUPPORT;    $arr['modify'] = $row['modify'];    $arr['l'] = RE_WIN;    $arr['mid'] = $row['mid2'];    $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,     $row['pid1'],$row['tid1'],$row['mid1'],     $row['pid2'],$row['tid2'],$row['mid2'], $row['cid']);    $arr['data'] .= ','.RE_SUPPORT_T.':'.$row['pid1'].':'.$row['tid1'].':'.implode(':',$temp);    $dbo->InsertRow(DB_PERFIX.'reports',$arr);    $arr['pid'] = $row['pid2'];    $dbo->InsertRow(DB_PERFIX.'reports',$arr);   }      public function SendBlockage(&$row,$re)      {          global $dbo;          $arr = array();          $arr['pid'] = $row['pid1'];          $arr['pid1'] = $row['pid1'];          $arr['pid2'] = $row['pid2'];          $arr['kind'] = RE_BLOCKADE;          $arr['modify'] = $row['modify'];          $arr['l'] = RE_WIN;          $arr['mid'] = $row['mid2'];          $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,              $row['pid1'],$row['tid1'],$row['mid1'],              $row['pid2'],$row['tid2'],$row['mid2'], '0');          $arr['data'] .= RE_ATTAKER_T.':'.$row['pid1'].':'.$row['tid1'].':'.implode(':',$re);          $dbo->InsertRow(DB_PERFIX.'reports',$arr);          $arr['pid'] = $row['pid2'];          $dbo->InsertRow(DB_PERFIX.'reports',$arr);      }      public function BlockadeWar(&$row,$r,$pid,$tid,&$attacker,$defence,$single)      {          global $dbo;          $arr = array();          $arr['pid'] = $pid;          $arr['pid1'] = $row['pid1'];          $arr['pid2'] = $row['pid2'];          $arr['kind'] = RE_BLOCKAGE_WAR;          $arr['modify'] = $row['modify'];          $arr['l'] = $r;          $arr['mid'] = $row['mid2'];          $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,              $row['pid1'],$row['tid1'],$row['mid1'],              $row['pid2'],$row['tid2'],$row['mid2'], '0');          $arr['data'] .= RE_ATTAKER_T.':'.$row['pid1'].':'.$row['tid1'].':'.implode(':',$attacker);          if($single)              $arr['data'] .= ','.RE_BLOCKAGE_T.':'.$pid.':'.$tid.':'.implode(':',$defence);          else          {              foreach($defence as $d)                  $arr['data'] .= ','.RE_BLOCKAGE_T.':0:0:'.implode(':',$d);          }          $dbo->InsertRow(DB_PERFIX.'reports',$arr);      }      public function SaveSupport(&$row,$pid,$tid,$temp,$l,$kind)      {          global $dbo;          $arr = array();          $arr['pid1'] = $row['pid1'];          $arr['pid2'] = $row['pid2'];          $arr['pid'] = $pid;          $arr['l'] = $l;          $arr['kind'] = $kind;          $arr['mid'] = $row['mid2'];          $arr['flag'] = 0;          $arr['data'] = sprintf('%s:%s:%s:%s:%s:%s:%s:%s,',RE_INFO,              $row['pid1'],$row['tid1'],$row['mid1'],              $row['pid2'],$row['tid2'],$row['mid2'], $row['cid']);          $arr['data'] .= ','.RE_SUPPORT_T.':'.$pid.':'.$tid.':'.implode(':',$temp);          $arr['modify'] = $row['modify'];          $dbo->InsertRow(DB_PERFIX.'reports',$arr);      }  }  $report = new Report;  ?>
<?php  require_once('lib/dbo.php');  require_once('lib/config.php');  require_once('lib/object.php');  require_once('lib/defines.php');  require_once('lib/utility.php');  class Post  {   protected $_topic;   public $_list;   public function __construct($tid)   {    $this->_topic = $tid;   }   public function CountRow()   {    global $dbo;    return $dbo->ExectueScaler(sprintf('SELECT COUNT(*) AS `n` FROM `%stopic_p` WHERE `ac` = \'1\' AND `tid` = \'%s\'',     DB_PERFIX, $this->_topic), 'n');   }   public function Load($row,$page)   {    global $dbo;    $sql = $dbo->ExectueQuery(     sprintf('SELECT `p`.*, COUNT(`l`.`id`) AS `like` FROM `%stopic_p`  AS `p` LEFT JOIN `%stopic_l` AS `l` ON (`p`.`id` = `l`.`poid`) WHERE `p`.`tid` = \'%s\' AND `p`.`ac` = \'1\' GROUP BY `p`.`id` LIMIT %s, %s',     DB_PERFIX, DB_PERFIX, $this->_topic, $row*$page, $row));    $this->_list = array();    while($row = $dbo->Read($sql))     $this->_list[$row['id']] = new Object($row);      $dbo->Cancel($sql);   }   public function IsLike($poid,$pid)   {    global $dbo;    return $dbo->ExectueScaler(     sprintf('SELECT COUNT(*) AS `l` FROM `%stopic_l` WHERE `poid` = \'%s\' AND `pid` = \'%s\'',      DB_PERFIX, $poid, $pid), 'l');   }   public function NewPost($tid,$pid,$pname,$message)   {    global $dbo;    $pname = $dbo->EscapeString($pname);    $arr = array();    $arr['tid'] = $tid;    $arr['pid'] = $pid;    $arr['pname'] = $pname;    $arr['message'] = empty($message)?NULL: mb_substr($message,0, 2048,'UTF-8');     $arr['modify'] = $_SERVER['REQUEST_TIME'];    $dbo->InsertRow(sprintf('%stopic_p',DB_PERFIX), $arr);    return $dbo->InsertedID();   }   public function GetPage($poid)   {    global $dbo;    return (int)$dbo->ExectueScaler(     sprintf('SELECT COUNT(*) AS `c` FROM `%stopic_p` WHERE`id` <= \'%s\' AND `ac` = \'1\' AND `tid` = \'%s\'',     DB_PERFIX,$poid,$this->_topic),'c');   }   public function LoadPost($poid)   {    global $dbo;    $arr = $dbo->ExectueRow(     sprintf('SELECT * FROM `%stopic_p` WHERE `id` = \'%s\' AND `ac` = \'1\' AND `tid` = \'%s\''     ,DB_PERFIX,$poid,$this->_topic));    if(is_array($arr) and !empty($arr))     return new Object($arr);    return NULL;   }   public function EditPost(Object &$obj, $pid, $pname)   {    global $dbo;    $obj->message = empty($obj->message)?NULL: mb_substr($obj->message,0, 2048,'UTF-8');     $obj->eid = $pid;    $obj->ename = $dbo->EscapeString($pname);    $obj->modify = $_SERVER['REQUEST_TIME'];    $dbo->UpdateRow(sprintf('%stopic_p',DB_PERFIX),$obj->GetArray(),$obj->id);   }   public function DelPost(Object &$obj, $pid, $pname)   {    global $dbo;    $obj->eid = $pid;    $obj->ename = $dbo->EscapeString($pname);    $obj->modify = $_SERVER['REQUEST_TIME'];    $obj->ac = '0';    $dbo->UpdateRow(sprintf('%stopic_p',DB_PERFIX),$obj->GetArray(),$obj->id);   }  }  ?>
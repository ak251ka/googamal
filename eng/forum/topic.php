<?php  require_once('lib/dbo.php');  require_once('lib/object.php');  require_once('lib/defines.php');  class topic  {   protected $_topic;   protected $_members;   protected $_uid;   public function Load($uid)   {    $this->_uid = $uid;    $this->_topic = array();    $this->_members = array();    global $dbo;    $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM `%stopic` WHERE `uid` = \'%s\' AND `ac` = \'1\'', DB_PERFIX, $uid));    $this->_topic[ALL_USER] = array();    $this->_topic[UNION_MEMBER] = array();    $this->_topic[INVITED_MEMBER] = array();    while($row = $dbo->Read($sql))    {     $this->_topic[$row['types']][$row['id']] = new Object($row);     $this->_members[$row['id']] = $this->LoadMember($row['id']);    }    $dbo->Cancel($sql);   }   public function LoadMember($tid)   {    global $dbo;    $arr = array();    $sql = $dbo->ExectueQuery(    sprintf('SELECT `t`.`id`, `t`.`pid` , `a`.`name` FROM `%stopic_m` AS `t` LEFT JOIN `%saccount` AS `a` ON ( `t`.`pid` = `a`.`id`) WHERE `t`.`tid` = \'%s\'',      DB_PERFIX, DB_PERFIX, $tid));         $this->_members[$tid] = array();    while($row = $dbo->Read($sql))     $arr[$row['pid']] = new Object($row);    $dbo->Cancel($sql);    return $arr;   }   public function IsMember($tid,$pid)   {    if(!isset($this->_topic[INVITED_MEMBER][$tid]))     return true;    return isset($this->_members[$tid]) and isset($this->_members[$tid][$pid]);   }   protected function Add($pid,$tid)   {    $arr = array();    $arr['pid'] = $pid;    $arr['tid'] = $tid;    global $dbo;    $dbo->InsertRow(sprintf('%stopic_m',DB_PERFIX), $arr);   }   protected function DelMember($id)   {    global $dbo;    $dbo->DeleteRecord(sprintf('%stopic_m',DB_PERFIX), $id);   }   public function DelMembers($tid)   {    global $dbo;    $dbo->ExectueQuery(sprintf('DELETE FROM `%stopic_m` WHERE `tid` =\'%s\'',DB_PERFIX,$tid));   }   public function SetMember($tid, $arr)   {    $temp = $this->LoadMember($tid);    foreach ($arr as $a)    {     if(isset($temp[$a]))     {      unset($temp[$a]);     }     else      $this->Add($a,$tid);    }    if(!empty($temp))    {     foreach ($temp as $t)      $this->DelMember($t->id);      }    $this->Load($this->_uid);   }   public function DeleteTopic($tid)   {    global $dbo;    $dbo->ExectueQuery(sprintf('UPDATE `%stopic` SET `ac` = \'0\' WHERE `id` = \'%s\'', DB_PERFIX, $tid));    $dbo->ExectueQuery(sprintf('UPDATE `%stopic_p` SET `ac` = \'0\' WHERE `tid` = \'%s\'', DB_PERFIX, $tid));    $dbo->ExectueQuery(sprintf('DELETE FROM `%stopic_m` WHERE `tid` = \'%s\'', DB_PERFIX, $tid));    $dbo->ExectueQuery(sprintf('DELETE FROM `%stopic_l` WHERE `tid` = \'%s\'', DB_PERFIX, $tid));   }   public function GetTopic($type)   {    return $this->_topic[$type];   }   public function Topics($tid)   {    if(isset($this->_topic[ALL_USER][$tid]))     return $this->_topic[ALL_USER][$tid];    if(isset($this->_topic[UNION_MEMBER][$tid]))     return $this->_topic[UNION_MEMBER][$tid];    if(isset($this->_topic[INVITED_MEMBER][$tid]))     return $this->_topic[INVITED_MEMBER][$tid];    return NULL;   }   public function SaveTopic($o)   {    global $dbo;    $o->name = $dbo->EscapeString($o->name);    $o->desc = $dbo->EscapeString($o->desc);    $dbo->UpdateRow(sprintf('%stopic',DB_PERFIX),$o->GetArray(),$o->id);    $this->_topic[$o->types][$o->id] = $o;   }   public function InsertInto($o)   {    global $dbo;    $o->name = $dbo->EscapeString($o->name);    $o->desc = $dbo->EscapeString($o->desc);    $dbo->InsertRow(sprintf('%stopic',DB_PERFIX),$o->GetArray());    return $dbo->InsertedID();   }  }  $topic = new topic;  ?>
<?php  require_once('.//lib/dbo.php');  require_once('.//eng/main/account.php');  require_once('.//lib/form.php');  require_once('.//lib/defines.php');  if(!$session->Permission(READ_REPORT) or !isset($_GET['id']))  {   echo '<div class = "massageList">';   $form->BlockPage();   echo '</div>';   return;  }  $row = $dbo->ExectueRow(sprintf('SELECT * FROM `%sreports` WHERE `id` = \'%s\'',DB_PERFIX,ValidNumber($_GET['id'],true)));  if(empty($row) or ($row['pid'] != $account->id))  {   echo '<div class = "massageList">';   $form->BlockPage();   echo '</div>';   return;  }  $report->SetFlag($row['id'], $account->id, RE_READ);  $trow = explode(',',$row['data']);  $sql = $dbo->ExectueQuery(sprintf('SELECT `id`,`name`,`desc` FROM `%selixir_i`',DB_PERFIX));  $elixir = array();  while($r = $dbo->Read($sql))   $elixir[$r['id']] = $r;  $dbo->Cancel($sql);  $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM `%stroop_info`',DB_PERFIX));  $troop = array();  while($r = $dbo->Read($sql))   $troop[$r['kind']][$r['id'] > 14 ?  $r['id'] : $r['id'] - 14] = $r;  $dbo->Cancel($sql);  gc_collect_cycles();  $ttrow = array();  foreach($trow as &$r)   $ttrow[] = explode(':',$r);  $em = array();  ?>
<div class="massageList">
<center><?php  switch($row['kind'])  {   case RE_ESPIAL:    echo '<h3 class="rep_h">'.$lang['Espial'].'</h3>';    break;   case RE_SUPPORT:    echo '<h3 class="rep_h">'.$lang['Support'].'</h3>';    break;   case RE_ADVENTURE:    echo '<h3 class="rep_h">'.$lang['RP_K_4'].'</h3>';    break;   case RE_BLOCKADE:    echo '<h3 class="rep_h">'.$lang['Blockade'].'</h3>';    break;   case RE_TRADE:    echo '<h3 class="rep_h">'.$lang['RP_K_7'].'</h3>';    break;   default:    echo '<h3 class="rep_h">'.$lang['Attack'].'</h3>';    break;  }  ?></center>
<?php  function GetBuildingDestroy()  {      global $lang;      global $ttrow;      $res = array();      foreach($ttrow as $t)      {          if($t[0] == RE_BUILDING_D)              $res[] = sprintf('<img src = "img/tow/sma/%s_0_0.gif" alt = "%s" class = "i24" />   %s â†’ %s',              $t[1],$lang['b'.$t[1]],$t[3],$t[2]);          if($t[0] == RE_LOYALTY)              $res[] = sprintf($lang['LoyalityDown'],$t[1]);          if($t[0] == RE_DESTROY_TOWN)              $res[] = sprintf($lang['DestroyedTown'],$t[1]);          if($t[0] == RE_CAP)              $res[] = sprintf($lang['CaptureTown'],$t[1]);          if($t[0] == RE_FIRE_CASE)              $res[] = sprintf($lang['FireCase'],DateToString($t[1]));          if($t[0] == RE_CLOONEY_CAP)              $res[] = sprintf($lang['CaptureClooney'],$t[1]);        }      return $res;  }  function FindResource()  {   $res = array();   global $ttrow;   foreach($ttrow as $t)   {    if($t[0] == RE_RESOURCE)    {     for($i=1;$i<6;$i++)      $res[$i] = $t[$i];              if(isset($t[6]))              {                  $res[6] = $t[6];                  $res[7] = $t[7];              }    }   }   return $res;  }  function GetElixir($kind,$in, $temp = '')  {   global $lang;   global $ttrow;   global $elixir;   global $em;   global $form;   $c = count($ttrow);   $result = array();   $tc = 0;   for($i = $in;$i < $c; $i++)   {    if($ttrow[$i][0] != $kind)     continue;    if($ttrow[$i][0] == RE_ELIXIR_A or $ttrow[$i][0] == RE_ELIXIR_D)    {     $result[$tc] = sprintf('<img class = "i30s" src="img/eli/%s.gif" alt="%s" onclick = "modal.Show(\'moe%1$s\');"/> %s %s %s',      $ttrow[$i][1],       $elixir[$ttrow[$i][1]]['name'],       $ttrow[$i][3], $temp, $lang['Effect'] . ' ' . ($ttrow[$i][2] == ELIXIR_BAD ? $lang['Bad'] : $lang['Good']));    }    if($ttrow[$i][0] == RE_ELIXIR_F)    {    }    if(!isset($em[$ttrow[$i][1]]))    {     $em[$ttrow[$i][1]] = 1;     $form->AddModal('moe'.$ttrow[$i][1], $elixir[$ttrow[$i][1]]['name'],      sprintf('<img src="img/eli/%d.gif" alt="%s"/>%s',      $elixir[$ttrow[$i][1]]['id'],$elixir[$ttrow[$i][1]]['name'],$elixir[$ttrow[$i][1]]['desc']),'');    }    $tc++;   }   return $result;  }   if($ttrow[0][0] == RE_INFO)   {   echo '<table class="rep_table_top" style="border: 1px solid black; margin-right:140px; width:530px;">';   $row['name1'] = $account->GetName($row['pid1']);   $row['name2'] = $account->GetName($row['pid2']);   if(empty($row['name1']))    $row['name1'] = '???';   else    $row['name1'] = $form->PlayerLink($row['pid1'],$row['name1']);      if(empty($row['name2']))    $row['name2'] = '???';   else    $row['name2'] = $form->PlayerLink($row['pid2'],$row['name2']);      if($row['kind'] != RE_ADVENTURE)    printf('<tr><td colspn = "2">%s</td>',sprintf($lang['REPORT_'.$row['kind']], $row['pid1'] ? $row['name1'] : $lang['t6'],      $row['pid2'] ? $row['name2'] : $lang['t4']));   else    printf('<td  colspn = "2">%s</td>',$lang['REPORT_4']);   printf('<td>%s</td></tr>',DateToString($row['modify']));   $row['tname1'] = $town->GetName($ttrow[0][2]);   $row['tname2'] = $town->GetName($ttrow[0][5]);   $row['tname'] = '';   if(empty($row['tname1']))   {    $pos = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',DB_PERFIX,$ttrow[0]['3']));    $row['tname1'] = $form->MapLink($pos['x'],$pos['y'],'???');   }   else    $row['tname1'] = $form->TownLink($ttrow[0][2],$row['tname1']);   if(empty($row['tname2']))   {    $pos = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',DB_PERFIX,$ttrow[0]['6']));    $row['tname2'] = $form->MapLink($pos['x'],$pos['y'],'???');   }   else   {    $row['tname'] = $row['tname2'];    $row['tname2'] = $form->TownLink($ttrow[0][5],$row['tname2']);   }   printf('<tr><td>%s</td><td>%s</td></tr>',$lang['Source'],$row['tname1']);   printf('<tr><td>%s</td><td>%s</td></tr>',$lang['Target'],$row['tname2']);      if($ttrow[0][7])    printf('<tr><td>%s</td><td>%s</td></tr>',$lang['t4'],$form->ClooneyLink($ttrow[0][7],$row['tname']));   if($row['kind'] != RE_ADVENTURE)    echo '</table>';   }   $c = count($trow);   $arr = array();   for($i = 1; $i < $c; $i++)   {    if(in_array($i, $arr))     continue;    switch($ttrow[$i][0])    {     case RE_NEW_TOWN:      printf('<center>%s</center>',$lang['NewTown']);      break;     case RE_ATTAKER_T:         $e = GetElixir(RE_ELIXIR_A,$i,$lang['Use']);      $ex = GetBuildingDestroy();      $r = FindResource();      if($ttrow[$i][1] == 7)       $form->ShowReportTroops($ttrow[$i], $r, $e, $ex);      else       $form->ShowReportTroops($ttrow[$i], $r, $e, $ex);      break;     case RE_DEFENDANT_T:      $e = GetElixir(RE_ELIXIR_D,$i,$lang['Use']);      $ex = array();      $r = array();      $form->ShowReportTroops($ttrow[$i], $r, $e, $ex);      break;              case RE_BLOCKAGE_T:                  $e = array();                  $ex = array();                  $r = array();                  $form->ShowReportTroops($ttrow[$i], $r, $e, $ex);                  break;     case RE_SUPPORT_T:      $e = array();      $ex = array();      $r = array();      $form->ShowReportTroops($ttrow[$i], $r, $e, $ex);      break;     case RE_BUILDING_H:      printf('<table class="rep_table_top" style="border: 1px solid black; margin-right:140px; width:530px;margin-top:10px; margin-bottom:0px;"><tr><td>%s</td><td>%s</td></tr>',$lang['Building'],$lang['Level']);      $tc = (int)floor(count($ttrow[$i])/2);      for($j = 1;$j <=$tc; $j++)       printf('<tr><td><img src ="img/tow/sma/%s_0_0.gif" class = "i57" alt = "%s"/></td><td width="200">%s</td></tr>',        $ttrow[$i][$j*2 - 1],$lang['b'.$ttrow[$i][$j*2 - 1]],$ttrow[$i][$j*2]);      printf('</table>');      break;     case RE_RESOURCE:      if($row['kind'] == RE_TRADE)      {       $tc = count($ttrow[$i]);       printf('<table class="rep_table_top" style="border: 1px solid black; margin-right:140px; width:530px;margin-top:10px; margin-bottom:0px;"><tr><td colspan = "2">%s</td></tr>',$lang['Resource']);       for($j = 1; $j < $tc;$j++)       {        if($ttrow[$i][$j])         printf('<tr><td><img id = "r%d" src="img/res/r%d.gif" class = "i30"/></td><td>%s</td></tr>',$j,$j,$ttrow[$i][$j]);       }       echo '</table><br />';      }      elseif($row['kind'] == RE_ADVENTURE)      {       printf('<tr><td><img src="/img/res/r1.gif" id = "r1" class ="i24"/><img src="/img/res/r2.gif" id = "r2" class ="i24"/><img src="/img/res/r3.gif" id = "r3" class ="i24"/><img src="/img/res/r4.gif" id = "r4" class ="i24"/><img src="/img/res/r5.gif" id = "r5" class ="i24"/></td><td>%s</td></tr>',$ttrow[$i][1]);      }      break;     case RE_ELIXIR_F:      printf('<tr><td><img src="img/eli/%s.gif" class="i24" alt="%s"  /></td><td>%s</td></tr>',       $ttrow[$i][1],$lang['Elixir'],$ttrow[$i][2]);      break;     case RE_MONEY:      printf('<tr><td><img src="img/plus/m.gif" class="i24" alt="%s"  /></td><td>%s</td></tr>',$lang['Money'],$ttrow[$i][1]);      break;     case RE_HERO_LIFE:      printf('<tr><td>%s</td><td>- %s</td></tr>', $lang['Life'], $ttrow[$i][1]);      break;     case RE_HERO_EXP:      printf('<tr><td>%s</td><td>+ %s</td></tr>', $lang['exHP'], $ttrow[$i][1]);      break;     case RE_NOTHING:      printf('<tr><td colspan = "2">%s</td></tr>', $lang['NothingHappened']);      break;     case RE_TROOPS_F:      printf('<tr><td><img src="img/troop/s/%s_%s.gif" class="i24" alt="%s"  /></td><td>%s</td></tr>',       $account->kind,$ttrow[$i][1],$lang['Troops'],$ttrow[$i][2]);      break;     case RE_ITEM_FIND:      printf('<tr><td colspan = "2">%s</td></tr>', $lang['ItemFind']);      break;     case RE_MAP_FIND:       printf('<tr><td colspan = "2"><img src="img/her/te.gif" alt="%s" class = "i24" /></td></tr>', $lang['hTreasure']);      break;    }   }  if($row['kind'] == RE_ADVENTURE)   echo '</table>';  ?>
</div>
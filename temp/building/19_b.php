<?php   require_once('.//lib/dbo.php');  require_once('lib/form.php');  require_once('lib/utility.php');  require_once('.//lib/defines.php');  require_once('.//eng/main/account.php');  require_once('.//eng/main/baseUpdate.php');  require_once('.//eng/main/troop.php');  $pos = $dbo->ExectueRow(sprintf('SELECT `id`,`x`,`y`,`kind`,`subid` FROM `%smap_t` WHERE `id` = \'%s\'',      DB_PERFIX, $town->mid));  $form->AddText('btroop',$lang['Return']);  $form->AddText('rttp',$lang['TimeProcess']);  function BackForm(&$row, $table,$mid,$sp)  {   global $dbo;   $arr = array();   $arr['pid1'] = $row['pid1'];   $arr['pid2'] = $row['pid2'];   $arr['tid1'] = $row['tid1'];   $arr['tid2'] = $row['tid2'];      if(isset($row['cid']))       $arr['cid'] = $row['cid'];   $arr['mid1']= $row['mid'];   $arr['mid2'] = $mid;   for($i=1;$i<14;$i++)   {    $t = 't'.$i;    $arr[$t] = $row[$t];   }   $arr['kind'] = A_RETURN;   $arr['len'] = $sp;   $arr['modify'] = $sp + $_SERVER['REQUEST_TIME'];   $dbo->InsertRow(DB_PERFIX.'troop_s',$arr);      $dbo->DeleteRecord($table, $row['id']);  }  function BackFromBlockage(&$row)  {      $t1 = NULL;      $t2 = NULL;      global $town;      $kind = 0;      $t1 =& $town;      $ac = new Account($row['pid2']);      $kind = $ac->kind;      if(!$ac->UpdateTown($_SERVER['REQUEST_TIME'],$row['tid2']))          return;      $t2 = $ac->GetTown($row['tid2']);      if(is_null($t2))          return;      if(($t1->modify != $t2->modify) and($t1->modify != $_SERVER['REQUEST_TIME']))          return;      if(!$t1->Lock())          return;      if(!$t2->Lock())      {          $t1->UnLock();          return;      }      global $dbo;      $p1 = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',          DB_PERFIX, $t1->mid));      $p2 = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',          DB_PERFIX, $t2->mid));      $slow = MinSpeedTroop($kind, $row);      $distance = dist($p1['x'], $p2['x'], $p1['y'], $p2['y']);      $h1 = ceil($t1->ReduceTheDistance($distance, $slow['k'], $slow['sp']));      BackForm($row, DB_PERFIX.'troop_b', $t2->mid, $h1);      $t1->UnLock();      $t2->UnLock();  }  function BackFromSupport(&$row)  {      $t1 = NULL;      $t2 = NULL;      global $town;      $kind = 0;      if($town->id == $row['tid1'])      {          global $account;          $kind = $account->kind;          $t1 =& $town;          if($row['tid2'] == $row['tid1'])              $t2 =& $town;          else          {              if($row['pid1'] == $row['pid2'])                  $ac =& $account;              else                  $ac = new Account($row['pid2']);              if(!$ac->UpdateTown($_SERVER['REQUEST_TIME'],$row['tid2']))                  return;              $t2 = $ac->GetTown($row['tid2']);              if(is_null($t2))                  return;          }      }      else      {          $t2 =& $town;          $ac = new Account($row['pid1']);          $kind = $ac->kind;          if(!$ac->UpdateTown($_SERVER['REQUEST_TIME'],$row['tid1']))              return;          $t1 = $ac->GetTown($row['tid1']);          if(is_null($t1))              return;      }      if(($t1->modify != $t2->modify) and($t1->modify != $_SERVER['REQUEST_TIME']))          return;      if(!$t1->Lock())          return;      if(!$t2->Lock())      {          $t1->UnLock();          return;      }      $t1->AddFields(array('used'=>$row['used']));      global $dbo;      $p1 = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',          DB_PERFIX,$t1->mid));      $p2 = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',          DB_PERFIX,$row['mid']));      $slow = MinSpeedTroop($kind, $row);      $distance = dist($p1['x'], $p2['x'], $p1['y'], $p2['y']);      $h1 = ceil($t1->ReduceTheDistance($distance, $slow['k'], $slow['sp']));      BackForm($row, DB_PERFIX.'troop_su', $t2->mid, $h1);      $t1->UnLock();      $t2->UnLock();  }  if(isset($_POST['com']))  {   $_POST['kind'] = isset($_POST['kind'])? ValidNumber($_POST['kind'], true) : 0;      $row = $dbo->ExectueRow(sprintf('SELECT * FROM `%s` WHERE `id` = \'%u\' AND `d` = \'0\'',          (($_POST['com'] == RETURN_TROOP_SUPPORT) ? DB_PERFIX.'troop_su' : DB_PERFIX.'troop_b'), $_POST['kind']));      if(!empty($row) and ($town->modify == $_SERVER['REQUEST_TIME']))      {          if($_POST['com'] == RETURN_TROOP_BLOCKADE)              BackFromBlockage($row);          elseif($_POST['com'] == RETURN_TROOP_SUPPORT)              BackFromSupport($row);      }  }  ?>
<div><center><a href="javascript:void(0);" onClick="ShowHide('bts')"><?php echo $lang['Support'];?></a></center></div>
<div id = "bts">
<form id = "rstt" action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid,$town->id,RETURN_TROOP);?>" method="post">
<input type="hidden" name="com" value="<?php echo RETURN_TROOP_SUPPORT;?>"  />
<input type="hidden" name="kind" id = "k1" value="?"  />
<?php  $sql = $dbo->ExectueQuery(sprintf('(SELECT `su` . * , `p1`.`name` AS `pname1`, `p1`.`kind` , `p2`.`name` AS `pname2` , `m`.`x` AS `x` , `m`.`y` AS `y`,`m`.`kind` AS `mk`,`m`.`subid` AS `subid`, `t1`.`name` AS `tname1` , `t2`.`name` AS `tname2` FROM `%1$stroop_su` AS `su` LEFT JOIN `%1$saccount` AS `p1` ON ( `su`.`pid1` = `p1`.`id` ) LEFT JOIN `%1$saccount` AS `p2` ON ( `su`.`pid2` = `p2`.`id` ) LEFT JOIN `%1$stown` AS `t1` ON ( `su`.`tid1` = `t1`.`id` ) LEFT JOIN `%1$stown` AS `t2` ON ( `su`.`tid2` = `t2`.`id` ) LEFT JOIN `%1$smap_t` AS `m` ON ( `su`.`mid` = `m`.`id` ) WHERE `su`.`tid1` = \'%2$s\' AND `su`.`d` = \'0\') UNION ( SELECT `su` . * , `p1`.`name` AS `pname1` , `p1`.`kind`,`p2`.`name` AS `pname2` , `m`.`x` AS `x` , `m`.`y` AS `y` ,`m`.`kind` AS `mk`,`m`.`subid` AS `subid`, `t1`.`name` AS `tname1` , `t2`.`name` AS `tname2` FROM `%1$stroop_su` AS `su` LEFT JOIN `%1$saccount` AS `p1` ON ( `su`.`pid1` = `p1`.`id` ) LEFT JOIN `%1$saccount` AS `p2` ON ( `su`.`pid2` = `p2`.`id` ) LEFT JOIN `%1$stown` AS `t1` ON ( `su`.`tid1` = `t1`.`id` ) LEFT JOIN `%1$stown` AS `t2` ON ( `su`.`tid2` = `t2`.`id` ) LEFT JOIN `%1$smap_t` AS `m` ON ( `t1`.`mid` = `m`.`id` ) WHERE (`su`.`tid2` = \'%2$s\' AND `su`.`tid1` != `su`.`tid2` AND `su`.`d` = \'0\'))',      DB_PERFIX,$town->id));  $j = 0;    while($row = $dbo->Read($sql))  {   $distance = dist($row['x'],$pos['x'],$row['y'],$pos['y']);        $slow = MinSpeedTroop($account->kind, $row);      if($slow['k'] == 0)      {          $slow['sp'] = (($account->lvl + 1)/10) + 10;          $slow['k'] = 3;      }      $h1 = ceil($town->ReduceTheDistance($distance,$slow['k'],$slow['sp']));      $j++;      $name = '';      $kname = $lang['Town'];      if($row['mk'] == MAP_CLOONEY)          $name = $form->ClooneyLink($row['subid'],$row['tname2']);      else          $name = $form->TownLink($row['tid2'],$row['tname2']);      printf('<br /><table border="1" style="width:700px"><tr><td colspan = "2">%s</td><td colspan = "6">%s</td><td>%s</td><td colspan = "6">%s</td></tr><tr><td>%s</td><td colspan = "6">%s</td><td><img src="img/res/t.gif" id = "rttp" class="i24"  /></td><td colspan = "3">%s</td><td colspan = "3" class = "counter">%s</td><td><img class="i24s" src="img/all/c1.gif" id = "btroop" onclick="SubmitForm(\'rstt\',\'k1\',\'%s\');"  /></td></tr>',          $lang['Player'],$form->PlayerLink($row['pid1'],$row['pname1']),$lang['Town'],$form->TownLink($row['tid1'],$row['tname1']),$lang['Location'],          $name,          SecToString($h1),          date('H:i:s',$_SERVER['REQUEST_TIME'] + $h1),          $row['id']);      echo AddTroopH($row['kind']);      printf('<tr><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%d</td><td>%d</td><td>%d</td></tr></table>',          $row['t1'], $row['t2'], $row['t3'], $row['t4'], $row['t5'], $row['t6'], $row['t7'], $row['t8'], $row['t9'], $row['t10'],          $row['t11'], $row['t12'],$row['t13'], $row['t14'],$row['h']);  }  gc_collect_cycles();  if(!$j)      printf('<center>%s</center>', $lang['NoRecord']);  $dbo->Cancel($sql);  ?>
</form>
</div>
<?php  $sql = $dbo->ExectueQuery(sprintf('SELECT `b`.*,`m`.`x`,`m`.`y`,`t`.`name` AS `tname`, `a`.`name` AS `aname` FROM `%1$stroop_b`AS  `b` LEFT JOIN `%1$smap_t` AS `m` ON (`b`.`mid` = `m`.`id`) LEFT JOIN `%1$stown` AS `t` ON (`b`.`tid2` = `t`.`id`) LEFT JOIN `%1$saccount` AS `a` ON (`b`.`pid2` = `a`.`id`) WHERE `b`.`tid1` = \'%2$s\' AND `b`.`d` = \'0\';',   DB_PERFIX, $town->id));  ?>
<div><center><a href="javascript:void(0);" onClick="ShowHide('btb')"><?php echo $lang['Blockade'];?></a></center></div>
<div id = "btb">
<form id = "rbtt" action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid,$town->id,RETURN_TROOP);?>" method="post">
<input type="hidden" name="com" value="<?php echo RETURN_TROOP_BLOCKADE;?>"  />
<input type="hidden" name="kind" id = "k2" value="?"  />
<?php  $j = 0;  while($row = $dbo->Read($sql))  {      $distance = dist($row['x'],$pos['x'],$row['y'],$pos['y']);      $slow = MinSpeedTroop($account->kind, $row);      $h1 = ceil($town->ReduceTheDistance($distance,$slow['k'],$slow['sp']));      $j++;      $name = '&nbsp;';      printf('<br /><table border="1" style="width:700px">      <tr><td>%s</td><td>%s</td><td colspan = "6">%s</td><td>%s</td><td colspan = "6">%s</td></tr>      <tr><td colspan = "7">&nbsp;</td><td><img src="img/res/t.gif" id = "rttp" class="i24"  /></td><td colspan = "3">%s</td><td colspan = "3" class = "counter">%s</td><td><img class="i24s" src="img/all/c1.gif" id = "btroop" onclick="SubmitForm(\'rbtt\',\'k2\',\'%s\');"  /></td></tr>',          $lang['Location'],$lang['Player'],          (empty($row['aname']) ? '&nbsp;' : $form->PlayerLink($row['pid2'],$row['aname'])),          $lang['Town'],          (empty($row['tname']) ? '&nbsp;' : $form->TownLink($row['tid2'],$row['tname'])),          SecToString($h1),          date('H:i:s',$_SERVER['REQUEST_TIME'] + $h1),          $row['id']);      echo AddTroopH($account->kind);      printf('<tr><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%u</td><td>%d</td><td>%d</td><td>%d</td></tr></table>',          $row['t1'], $row['t2'], $row['t3'], $row['t4'], $row['t5'], $row['t6'], $row['t7'], $row['t8'], $row['t9'], $row['t10'],          $row['t11'], $row['t12'],$row['t13'], $row['t14'],$row['h']);  }  gc_collect_cycles();  if(!$j)   printf('<center>%s</center>', $lang['NoRecord']);  $dbo->Cancel($sql);  ?>
</form>
</div>

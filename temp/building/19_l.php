<?php  require_once('.//lib/form.php');  require_once('.//lib/dbo.php');  require_once('eng/main/troop.php');  if(isset($_POST['com']) and $_POST['com'] == CANCEL_SEND_TROOP)  {   $_POST['kind'] = isset($_POST['kind'])? ValidNumber($_POST['kind'],true) : 0;   $row = $dbo->ExectueRow(sprintf('SELECT * FROM `%stroop_s` WHERE `id` = \'%u\' AND `pid1` = \'%s\' AND `tid1` = \'%s\' AND `d` = \'0\'',     DB_PERFIX, $_POST['kind'], $account->id, $town->id));   if(!empty($row))   {    $modify = $row['modify'];    if(($row['kind'] != A_RETURN) and (($modify - $row['len']) >= ($_SERVER['REQUEST_TIME'] - (ONE_TICK / 60))))    {     $row['e1'] =      $row['e2'] =      $row['ne1'] =      $row['ne2'] = 0;     $row['kind'] = A_RETURN;     $row['len'] = $row['len'] - ($modify - $_SERVER['REQUEST_TIME']);     $row['modify'] = ($_SERVER['REQUEST_TIME'] + $row['len']);     $dbo->UpdateRow(DB_PERFIX.'troop_s', $row, $row['id']);    }   }  }  ?>
<table border="1" style="width:700px">
<?php echo AddTroopH($account->kind); echo '<tr>';  for($i = 1;$i<15;$i++)  {   $t = 't'.$i;   printf('<td>%d</td>',$town->$t);  }  printf('<td>%d</td>',$town->h);  echo '</tr>';  ?>
</table>
<?php  $count = $dbo->ExectueScaler(   sprintf('SELECT COUNT(*) AS `c` FROM `%stroop_s` WHERE (`tid1` = \'%s\' OR `tid2` = \'%s\') AND NOT(`tid1` != \'%s\' AND `kind` = \'%s\') AND `d` = \'0\'',   DB_PERFIX,$town->id, $town->id,$town->id,A_ESPIAL),'c');  $p = isset($_GET['page']) ? ValidNumber($_GET['page'],true) : 0;  $r = isset($_GET['row']) ? ValidNumber($_GET['row'],true) : 30;  if($p * $r > $count)   $p = 0;  $sql = $dbo->ExectueQuery(sprintf('SELECT `ts`. * , `p1`.`name` AS `pname1` , `p2`.`name` AS `pname2` , `t1`.`name` AS `tname1` , `t2`.`name` AS `tname2` , `p1`.`kind` AS `k1` FROM `%1$stroop_s` AS `ts` LEFT JOIN `%1$saccount` AS `p1` ON ( `ts`.`pid1` = `p1`.`id` ) LEFT JOIN `%1$saccount` AS `p2` ON ( `ts`.`pid2` = `p2`.`id` ) LEFT JOIN `%1$stown` AS `t1` ON ( `ts`.`tid1` = `t1`.`id` ) LEFT JOIN `%1$stown` AS `t2` ON ( `ts`.`tid2` = `t2`.`id` ) WHERE `ts`.`d` = \'0\' AND (( `ts`.`tid1` = \'%2$s\' ) OR (`ts`.`tid2` = \'%2$s\' AND NOT (`ts`.`kind` = \'%3$s\' OR `ts`.`kind` = \'%4$s\'))) ORDER BY `ts`.`modify` ASC LIMIT %5$d, %6$d',   DB_PERFIX, $town->id, A_ESPIAL, A_RETURN, $p*$r, $r));  if(!$dbo->RowsNumber($sql))  {   $dbo->Cancel($sql);   gc_collect_cycles();   return;  }  ?>
<form id = "<?php echo CANCEL_SEND_TROOP;?>" action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;page=%d&amp;row=%d&amp;show=%s',   $bid,$town->id,$p,$r,LIST_TROOP);?>" method="post">
<input type="hidden" name="com" value = "<?php echo CANCEL_SEND_TROOP;?>"  />
<input type="hidden" name="kind" id = "kind" value="?" />
<?php  while($row = $dbo->Read($sql))  {   EchoHeader($row);   EchoTroop($row,($row['pid1'] == $account->id) or ($row['pid1'] == '7'));   if($account->id == $row['pid1'] and $row['kind'] == A_RETURN)    EchoRes($row['r1'],$row['r2'],$row['r3'],$row['r4'],$row['r5'],$row['modify']);   else    EchoTimes($row['modify']);  }  $dbo->Cancel($sql);  gc_collect_cycles();  function EchoRes($r1,$r2,$r3,$r4,$r5,$times)  {   global $form;   global $lang;   printf('<tr><td><img src = "img/res/r1.gif" alt="%s" class="i24" ></td><td>%u</td><td><img src = "img/res/r2.gif" alt="%s" class="i24" ></td><td>%u</td><td><img src = "img/res/r3.gif" alt="%s" class="i24" ></td><td>%u</td><td><img src = "img/res/r4.gif" alt="%s" class="i24" ></td><td>%u</td><td><img src = "img/res/r5.gif" alt="%s" class="i24" ></td><td>%u</td><td><img src = "img/res/t.gif" alt="%s" class="i24" ></td><td colspan="2"  width="65px;">%s</td><td colspan="2">%s</td></tr></table>',$lang['r1'],$r1,$lang['r2'],$r2,$lang['r3'],$r3,$lang['r4'],$r4,$lang['r5'],$r5,$lang['TimeProcess'],$form->Addtimer($times,'building.php?id=19'),DateToString($times));  }  function EchoTimes($times)  {   global $form;   global $lang;   printf('<tr><td colspan="10">&nbsp;</td><td><img src = "img/res/t.gif" alt="%s" class="i24" ></td><td colspan="2" width="65px;">%s</td><td colspan="2">%s</td></tr></table>',    $lang['TimeProcess'],$form->Addtimer($times,'building.php?id=19'),DateToString($times));  }  function EchoHeader(&$a)  {   global $account;   global $lang;   global $form;   $cancel = '&nbsp;';   $kt = '';   switch($a['kind'])   {    case A_RAPINE:     $kt = $lang['Rapine'];     break;    case A_ESPIAL:     $kt = $lang['Espial'];     break;    case A_SUPPORT:     $kt = $lang['Support'];     break;    case A_ATTACK:     $kt = $lang['Attack'];     break;    case A_BLOCKADE:     $kt = $lang['Blockade'];     break;    case A_MERGER:     $kt = $lang['Merger'];     break;    case A_NEW_TOWN:     $kt = $lang['NewTown'];     break;    case A_ADVENTURE:     $kt = $lang['Adventure'];     break;    case A_TREASURE:     $kt = $lang['Treasure'];     break;    case A_RETURN:     $kt = $lang['Return'];     break;   }   if($a['pid1'] == $account->id)   {    if($a['kind'] != A_RETURN)     $kind = 'i3';    else     $kind = 'h4';    if($a['kind'] != A_RETURN and ($a['modify'] - $a['len']) >= (int)$_SERVER['REQUEST_TIME'] - (ONE_TICK/60))    {     $cancel = sprintf('<img src="img/all/f2.gif" alt="%s" class="i24s" onclick="SubmitForm(\'%s\',\'kind\',\'%s\');"  />',      $lang['Cancel'],CANCEL_SEND_TROOP, $a['id']);    }   }   else   {    switch($a['kind'])    {     case A_RAPINE:      $kind = 'd3';      break;     case A_ATTACK:      $kind = 'd1';      break;     default:      $kind = 'd2';      break;    }   }    if($a['kind'] != A_RETURN)    {     printf('<br /><table border="1" style="width:700px"><tr><td><img src = "img/all/%s.gif" alt="%s" class = "i24"/></td><td>%s</td><td colspan="6">%s</td><td>%s</td><td colspan="6">%s</td></tr>',     $kind,$kt,$lang['Source'],$form->PlayerLink($a['pid1'],$a['pname1']),$lang['Town'],$form->TownLink($a['tid1'],$a['tname1']));     if($a['kind'] == A_ADVENTURE)      printf('<tr><td>%s</td><td colspan="14">%s</td></tr>',       $cancel,$lang['Adventure']);     elseif($a['kind'] == A_TREASURE)      printf('<tr><td>%s</td><td colspan="14">%s</td></tr>',       $cancel,$lang['Treasure']);     else     {      if($a['cid'])       printf('<tr><td>%s</td><td>%s</td><td colspan="6">%s</td><td>%s</td><td colspan="6">%s</td></tr>',        $cancel,$lang['Target'],$form->PlayerLink($a['pid2'],$a['pname2']),$lang['Clooney'],$form->ClooneyLink($a['cid'],$a['tname2']));      else       printf('<tr><td>%s</td><td>%s</td><td colspan="6">%s</td><td>%s</td><td colspan="6">%s</td></tr>',        $cancel,$lang['Target'],$form->PlayerLink($a['pid2'],$a['pname2']),$lang['Town'],$form->TownLink($a['tid2'],$a['tname2']));     }    }    else    {     printf('<br /><table border="1" style="width:700px"><tr><td><img src = "img/all/%s.gif" alt="%s" class = "i24"/></td><td>%s</td><td colspan="6">%s</td><td>%s</td><td colspan="6">%s</td></tr>',      $kind,$kt,$lang['Target'],$form->PlayerLink($a['pid1'],$a['pname1']),$lang['Town'],$form->TownLink($a['tid1'],$a['tname1']));     if($a['tid2'])     {      printf('<tr><td>&nbsp;</td><td>%s</td><td colspan="6">%s</td>',$lang['Source'],$form->PlayerLink($a['pid2'],$a['pname2']));      if($a['cid'])       printf('<td>%s</td><td colspan="6">%s</td></tr>',$lang['Clooney'],$form->ClooneyLink($a['cid'], $a['tname2']));      else       printf('<td>%s</td><td colspan="6">%s</td></tr>',$lang['Town'],$form->TownLink($a['tid2'], $a['tname2']));     }     elseif($a['cid'])      printf('<td>%s</td><td colspan="15">%s</td></tr>',$lang['Map'],$form->ClooneyLink($a['cid'],''));     elseif($a['mid2'])      printf('<td>%s</td><td colspan="15">%s</td></tr>',$lang['Map'], $form->MapLinkID($a['mid2'],$lang['EmptyLand']));     else      printf('<td colspan="15">%s</td></tr>',$lang['Return']);    }  }  function EchoTroop(&$a,$kind)  {   global $troops;   global $lang;   echo AddTroopH($a['k1']);   if($kind)    printf('<tr><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td><td>%d</td></tr>', $a['t1'], $a['t2'], $a['t3'], $a['t4'], $a['t5'], $a['t6'], $a['t7'], $a['t8'], $a['t9'], $a['t10'], $a['t11'], $a['t12'], $a['t13'], $a['t14'], $a['h']);   else    echo '<tr><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td><td>?</td></tr>';  }  ?>
</form>
<div>
<?php  echo Paging($count,sprintf('building.php?bid=%s&amp;tid=%s&amp;show=%s&amp;',   $bid,$town->id,LIST_TROOP),$r,$p).'<br />';  $list = array('tid'=>$town->id, 'bid' => $bid);  echo $form->AddPagingForm('building',LIST_TROOP,$p,$r,$list);  ?>
</div>
<div class="b_troop">
<?php  require_once('.//lib/form.php');  require_once('.//lib/dbo.php');  require_once('.//lib/defines.php');  $f = isset($_POST['kind'])? ValidNumber($_POST['kind'],true) : GET_TARGET;  $mT = 1;  $mT += $hero->GetPoint(14)*0.02;  $sT = $hero->GetPoint('HP3')/100;  $sT += $mT;  $hT = $town->$u - $dbo->ExectueScaler(sprintf('SELECT sum(`tr`) AS `c` FROM `%smarket` WHERE `tid1` = \'%s\' AND `d` = \'0\'',   DB_PERFIX,$town->id,$town->id),'c');  if(isset($_POST['kind']) and ($_POST['kind'] = ValidNumber($_POST['kind'],true)))  {   if($town->Lock())   {    $error = E_MARKET_NO_RESOURCE;    $total = 0;    for($i=1;$i<6;$i++)    {     $r = "r$i";     $_POST['tbR'.$i] = isset($_POST['tbR'.$i]) ? ValidNumber($_POST['tbR'.$i],true) : 0;     $_POST['tbR'.$i] = $_POST['tbR'.$i] > $town->$r ? $town->$r : $_POST['tbR'.$i];     if($_POST['tbR'.$i])     {      $error = NO_ERROR;      $total += $_POST['tbR'.$i];     }    }    if($error)     $f = TARGET_NOT_VALID;    elseif($total > $mT * 1000 * $hT)    {     $error = E_NO_TRADESFOLK;     $f = TARGET_NOT_VALID;    }    else    {     if(isset($_POST['tbName']) and !empty($_POST['tbName']))     {      $row  = $dbo->ExectueRow(sprintf('SELECT `id`,`mid` FROM `%stown` WHERE `name` = \'%s\'',       DB_PERFIX,$_POST['tbName']));      if(!empty($row))      {       $id = $row['id'];       $row  = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',       DB_PERFIX,$row['mid']));       $_POST['tbX'] = $row['x'];       $_POST['tbY'] = $row['y'];      }      else       $id = 0;      }     else     {      $_POST['tbX'] = isset($_POST['tbX']) ? ValidNumber($_POST['tbX']) : 0;      $_POST['tbY'] = isset($_POST['tbY']) ? ValidNumber($_POST['tbY']) : 0;      $id = $dbo->ExectueScaler(sprintf('SELECT `subid` FROM `%smap_t` WHERE `x` = \'%s\' AND `y` = \'%s\' AND `kind` = \'%s\'',      DB_PERFIX,$_POST['tbX'],$_POST['tbY'], MAP_TOWN),'subid');     }     if(!$id)     {      $f = TARGET_NOT_VALID;      $error = E_TOWN_NOT_FIND;     }     else     {      if($id == $town->id)      {       $f = TARGET_NOT_VALID;       $error = E_SELF_SEND;      }      else       $row = $dbo->ExectueRow(sprintf('SELECT `t`.`id` , `t`.`pid` , `t`.`name` AS `tname` , `a`.`name` AS `aname` FROM `%stown` AS `t` LEFT JOIN `%saccount` AS `a` ON ( `t`.`pid` = `a`.`id` ) WHERE `t`.`id` = \'%s\'',DB_PERFIX, DB_PERFIX,$id));     }    }   }   else    $f = GET_TARGET;  }  if($f ==SEND_VALID)  {   $f = TARGET_NOT_VALID;      $town->Lock();   if($town->SubResource($_POST['tbR1'],$_POST['tbR2'],$_POST['tbR3'],$_POST['tbR4'],$_POST['tbR5']))   {    $error = NO_ERROR;    $f = TARGET_NOT_VALID;    $error = NO_ERROR;    $pos = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `subid` = \'%s\' AND `kind` = \'%s\' ',              DB_PERFIX, $town->id, MAP_TOWN));    $town->SendResource($id, $_POST['tbR1'], $_POST['tbR2'], $_POST['tbR3'], $_POST['tbR4'], $_POST['tbR5'],     Distance($pos['x'],$_POST['tbX'],$pos['y'],$_POST['tbY'], round(TRADESFLOK * $sT)),     (int)ceil($total / ($mT * 1000)));   }   else    $error = E_MARKET_NO_RESOURCE;      $town->UnLock();  }  $town->UnLock();  $hT = $town->$u - $dbo->ExectueScaler(sprintf('SELECT sum(`tr`) AS `c` FROM `%smarket` WHERE `tid1` = \'%s\' AND `d` = \'0\'',   DB_PERFIX,$town->id,$town->id),'c');  printf($lang['HaveTradesfolk'],$hT,$town->$u, $mT * 1000, round($sT * TRADESFLOK));  if($f == TARGET_NOT_VALID)  {   switch($error)   {    case E_NO_TRADESFOLK:     printf('<center><b>%s</b></center>', $lang['E_NO_Tradesfolk']);     break;    case E_MARKET_NO_ELIXIR:     printf('<center><b>%s</b></center>',$lang['E_MARKET_NO_RESOURCE']);     break;    case E_SELF_SEND:     printf('<center><b>%s</b></center>',sprintf($lang['E_SELF_SEND'],$lang['Resource']));     break;    case E_TOWN_NOT_FIND:     printf('<center><b>%s</b></center>',$lang['E_TOWN_NOT_FIND']);     break;    case NO_ERROR:     printf('<center><b>%s</b></center>',sprintf($lang['E_SEND_SUC'],$lang['Resource']));     break;   }   $f = GET_TARGET;  }    ?>
<form action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid, $town->id, RESOURCE_MARKET_SEND);?>" method="post">
<input type = "hidden" name="com" value="<?php echo RESOURCE_MARKET_SEND;?>"  />
<input type="hidden" name="kind" value="<?php echo $f + 1;?>" />
<?php  if($f == GET_TARGET)  {      $tpos = array('x' => 0, 'y' => 0);      if(!empty($_GET))      {          if(isset($_GET['mid']))          {              $location = $dbo->ExectueRow(sprintf('SELECT * FROM `%smap_t` WHERE `id` = \'%s\'', DB_PERFIX, $_GET['mid']));              if(!empty($location))              {                  $tpos['x'] = $location['x'];                  $tpos['y'] = $location['y'];              }            }      }   printf('<table class="bazRight" style="float:right;margin-right:30px;margin-top:10px;"><tr><td>%s</td><td><input type="text" value="" name="tbName" /></td></tr><tr><td colspan="2">%s</td></tr><tr><td>X</td><td><input type="text" value="%s" name="tbX" /></td></tr><tr><td>Y</td><td><input type="text" value="%s" name="tbY" /></td></tr><tr></tr></table>',$lang['Name'],$lang['OR'],$tpos['x'],$tpos['y']);   $j = 0;  printf('<table style="float:left;margin-top:10px;"><tr><td width = "60px;"><img src="img/res/r1.gif" alt="%s" class="i30" /></td><td><input type="text" name = "tbR1" value="0" /></td></tr><tr><td><img src="img/res/r2.gif" alt="%s" class="i30" /></td><td><input type="text" name = "tbR2" value="0" /></td></tr><tr><td><img src="img/res/r3.gif" alt="%s" class="i30" /></td><td><input type="text" name = "tbR3" value="0" /></td></tr><tr><td><img src="img/res/r4.gif" alt="%s" class="i30" /></td><td><input type="text" name = "tbR4" value="0" /></td></tr><tr><td><img src="img/res/r5.gif" alt="%s" class="i30" /></td><td><input type="text" name = "tbR5" value="0" /></td></tr></table>',$lang['r1'],$lang['r2'], $lang['r3'], $lang['r4'], $lang['r5']);  printf('<div style="clear:both"></div><center><input type="submit" value="%s" /></center>',$lang['Send']);  }  elseif($f == CHECK_VALID)  {   $pos = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `subid` = \'%s\' AND `kind` = \'%s\'',DB_PERFIX,$town->id,MAP_TOWN));   printf('<table class="bazRight" style="float:right;margin-right:30px;margin-top:10px;"><tr><td width = "100px;">%s</td><td>%s</td></tr><tr><td>%s</td><td>%s</td></tr><tr><td>%s</td><td>%s</td></tr><tr><td>%s</td><td class="counter">%s</td></tr><tr><td>%s</td><td>%s</td></tr></table>',    $lang['Player'],$form->PlayerLink($row['pid'],$row['aname']),$lang['Town'],$form->TownLink($row['id'],$row['tname']),          $lang['TimeProcess'], SecToString(Distance($pos['x'],$_POST['tbX'],$pos['y'],$_POST['tbY'],round(TRADESFLOK*$sT))),          $lang['InHour'], date('H:i:s',$_SERVER['REQUEST_TIME'] + Distance($pos['x'],$_POST['tbX'],$pos['y'],$_POST['tbY'],round(TRADESFLOK*$sT))),    $lang['Tradesfolk'],ceil($total / ($mT * 1000)));   $str = '';   echo '<table style="float:left;margin-top:10px;width:200px;">';   for($i = 1; $i < 6; $i++)   {    if($_POST['tbR'.$i])    {     printf('<tr><td width="50px;"><img src="img/res/r%d.gif" alt="%s" class="i30"  /></td><td>%d</td></tr>',$i,$lang['r'.$i],$_POST['tbR'.$i]);     $str .= sprintf('<input type="hidden" name="tbR%d" value="%d" />',$i, $_POST['tbR'.$i]);    }   }   echo '</table>'.$str;   printf('<input type="hidden" name="tbX" value="%s"  /><input type="hidden" name="tbY" value="%s"  />',$_POST['tbX'],$_POST['tbY']);   printf('<div style="clear:both"></div><center><input type="submit" value="%s" /></center>',$lang['Send']);  }  ?>
</form>
<?php  $sql = $dbo->ExectueQuery(sprintf('SELECT `m` . * , `t1`.`name` AS `tname1` , `t2`.`name` AS `tname2` FROM `%smarket` AS `m` LEFT JOIN `%stown` AS `t1` ON ( `m`.`tid1` = `t1`.`id` ) LEFT JOIN `%stown` AS `t2` ON ( `m`.`tid2` = `t2`.`id` ) WHERE (`m`.`kind` != \'%s\') AND (`m`.`tid1` = \'%s\' OR `m`.`tid2` = \'%s\') AND (`m`.`d` = \'0\') ORDER BY `m`.`modify` ASC',  DB_PERFIX,DB_PERFIX,DB_PERFIX,MARKET_WAIT,$town->id,$town->id));  if($dbo->RowsNumber($sql))  {   printf('<table><tr><td>%s</td><td>%s</td><td>%s</td><td colspan="2">%s</td><td>%s</td></tr>',    $lang['Source'],$lang['Target'],$lang['Resource'],$lang['InDate'],$lang['Kind']);   $j = 0;   $ref = sprintf('building.php?bid=%s&tid=%s&show=%s',$bid, $town->id, RESOURCE_MARKET_SEND);   while($row = $dbo->Read($sql))   {        if($row['tid1'] != $town->id and $row['kind'] == MARKET_RETURN)     continue;    $j++;    printf('<tr class ="ml%s"><td>%s</td><td>%s</td><td><img src="img/res/r1.gif" alt="%s" class="i16" />%s<img src="img/res/r2.gif" alt="%s" class="i16" />%s<img src="img/res/r3.gif" alt="%s" class="i16" />%s<img src="img/res/r4.gif" alt="%s" class="i16" />%s<img src="img/res/r5.gif" alt="%s" class="i16" />%s</td><td width = "100px;">%s</td><td>%s</td><td>%s</td></tr>',     $row['kind'],$form->TownLink($row['tid1'], $row['tname1']),$form->TownLink($row['tid2'], $row['tname2']),     $lang['r1'],$row['r1'],$lang['r2'],$row['r2'],$lang['r3'],$row['r3'],$lang['r4'],$row['r4'],$lang['r5'],$row['r5'],     $form->Addtimer($row['modify'],$ref),DateToString($row['modify']),$row['kind'] == MARKET_SEND ? $lang['Go']: $lang['Back']);   }   if(!$j)    printf('<tr><td colspan="5">%s</td></tr>',$lang['NoRecord']);   printf('</table>');  }  $dbo->Cancel($sql);  gc_collect_cycles();  ?>
</div>
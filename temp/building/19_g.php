<?php  require_once('.//lib/config.php');  require_once('.//lib/dbo.php');  require_once('eng/main/validation.php');  if(!$account->golden)  {   echo $lang['GoldenClub'];   return;  }  $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM `%stroop_info` WHERE `kind` = \'%s\'',      DB_PERFIX, $account->kind));  $i = 1;  while($row = $dbo->Read($sql))  {      $form->AddModal('mot'.$i,$row['name'],sprintf('<img src="img/troop/b/%d_%d.gif" class="bigimg" alt="%s"/>%s',          $account->kind,$i,$row['name'],$row['desc']),$form->TroopInfo(          $row['r1'],$row['r2'],$row['r3'],$row['r4'],$row['r5'],          SecToString($row['times']),$row['used'],          $troops[$account->kind][$i][0],          $troops[$account->kind][$i][1],          $troops[$account->kind][$i][2],          $troops[$account->kind][$i][3],          $troops[$account->kind][$i][4],          $troops[$account->kind][$i][5]));      $i++;      if($i == 13)          break;  }  $dbo->Cancel($sql);  function ShowHeader($kind)  {      global $troops;      echo '<tr>';      for($i = 1; $i < 13; $i ++)      {          printf('<td><img src="img/troop/s/%s_%s.gif" class = "i30s" onclick="modal.Show(\'mot%s\');" alt = "%s"/></td>',              $kind,$i,$i,$troops[$kind][$i][6]);      }      echo '</tr>';  }  if(isset($_POST['com']))  {      if(($_POST['com'] == ADD_GOLDEN_CLUB) or ($_POST['com'] == EDIT_GOLDEN_CLUB))      {          if($dbo->ExectueScaler(sprintf('SELECT COUNT(*) AS `c` FROM `%sgolden` WHERE `tid1` = \'%s\'',DB_PERFIX,$town->id),'c') >=100)              printf($lang['MaxPermission'],$lang['PlusGolden']);          else          {              $arr = array();              $canSave = false;              for($i = 1;$i< 13;$i++)              {                  $t = 't'.$i;                  $arr[$t] = (isset($_POST[$t]) ? ValidNumber($_POST[$t]) : 0);                  if($arr[$t])                      $canSave = true;              }              if($canSave)              {                  $arr['x'] = (isset($_POST['x']) ? ValidNumber($_POST['x']) : 0);                  $arr['y'] = (isset($_POST['y']) ? ValidNumber($_POST['y']) : 0);                  $mrow = $dbo->ExectueRow(sprintf('SELECT `id` AS `mid`,`subid` AS `tid` FROM `%smap_t` WHERE `x` = \'%s\' AND `y` = \'%s\' AND `kind` = \'%s\' AND `subid` != \'0\'',                      DB_PERFIX,$arr['x'],$arr['y'],MAP_TOWN));                  if(empty($mrow))                      printf('<center>%s</center>',$lang['E_TOWN_NOT_FIND']);                  else                  {                      if($dbo->ExectueScaler(sprintf('SELECT `pid` FROM `%stown` WHERE `id` = \'%s\' LIMIT 1;', DB_PERFIX,$mrow['tid']),'pid') == $account->id)                          printf('<center>%s</center>',$lang['E_ATTACK_SELF']);                      else                      {                          $arr['tid2'] = $mrow['tid'];                          $arr['mid'] = $mrow['mid'];                          $arr['tid1'] = $town->id;                          if($_POST['com'] == EDIT_GOLDEN_CLUB)                          {                              $_POST['kind'] =(isset($_POST['kind']) ? ValidNumber($_POST['kind'],true) : 0);                              $id = $dbo->ExectueScaler(sprintf('SELECT `id` FROM `%sgolden` WHERE  `id` = \'%s\' AND `tid1` = \'%s\'',DB_PERFIX,$_POST['kind'],$town->id),'id');                              if($id)                                  $dbo->UpdateRow(DB_PERFIX.'golden',$arr,$id);                          }                          else                              $dbo->InsertRow(DB_PERFIX.'golden',$arr);                      }                  }              }              else                  printf('<center>%s</center>',$lang['E_ATTACK_NO_TROOP']);          }      }      elseif($_POST['com'] == DEL_GOLDEN_CLUB)      {          $_POST['kind'] =(isset($_POST['kind']) ? ValidNumber($_POST['kind'],true) : 0);          $dbo->ExectueQuery(sprintf('DELETE FROM `%sgolden` WHERE  `id` = \'%s\' AND `tid1` = \'%s\'',DB_PERFIX,$_POST['kind'],$town->id));          $_POST['kind'] = 0;      }      elseif($_POST['com'] == CHANGE_GOLDEN_CLUB)      {          $_POST['kind'] =(isset($_POST['kind']) ? ValidNumber($_POST['kind'],true) : 0);          $golden = $dbo->ExectueRow(sprintf('SELECT * FROM `%sgolden` WHERE  `id` = \'%s\' AND `tid1` = \'%s\'',DB_PERFIX,$_POST['kind'],$town->id));          if(empty($golden))              unset($golden);      }      elseif($_POST['com'] == SEND_GOLDEN_CLUB)      {          $sending = $_POST;          $_POST = array();          $s = 0;          if($town->Lock())          {              if($town->modify == $_SERVER['REQUEST_TIME'])              {                  foreach($sending as $key => $value)                  {                      if(NoNumbers($key) == 's')                      {                          $temp = $dbo->ExectueRow(sprintf('SELECT * FROM `%sgolden` WHERE  `id` = \'%s\' AND `tid1` = \'%s\'',DB_PERFIX,ValidNumber($value,true),$town->id));                          if(empty($temp))                              continue;                          $_POST = array();                          for($i = 1;$i<13;$i++)                          {                              $t = 't'.$i;                              $_POST[$t] = $temp[$t];                          }                          $_POST['kind'] = A_RAPINE;                          $_POST['tbX'] = $temp['x'];                          $_POST['tbY'] = $temp['y'];                          $Validation->Start();                          $arr = array();                          $brr = array();                          if(!$Validation->disabled)                          {                              $s++;                              $arr['kind'] = A_RAPINE;                              $arr['pid1'] = $account->id;                              $arr['tid1'] = $town->id;                              $arr['mid1'] = $town->mid;                              $arr['pid2'] = $Validation->_info['pid'];                              $arr['tid2'] = $Validation->_info['tid'];                              $arr['mid2'] = $Validation->_info['mid'];                              $arr['cid'] = $Validation->_info['cid'];                              for($i = 1; $i<13;$i++)                              {                                  $t = 't'.$i;                                  $arr[$t] = $_POST[$t];                                  $brr[$t] = -$arr[$t];                              }                              $arr['h'] = '0';                              $arr['len'] = $Validation->_distance;                              $arr['modify'] = $_SERVER['REQUEST_TIME'] + $Validation->_distance;                              $town->AddFields($brr);                              $dbo->InsertRow(DB_PERFIX.'troop_s',$arr);                          }                          gc_collect_cycles();                      }                  }              }          }          $town->UnLock();          printf('<center>%s</center>',sprintf($lang['E_SEND_SUC'],$s));      }  }    ?>
<form action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid,$town->id,TROOP_GOLDEN_CLUB);?>" method="post">
<input type="hidden" value="<?php echo (isset($golden) ? EDIT_GOLDEN_CLUB : ADD_GOLDEN_CLUB);?>" name="com">
<input type="hidden" value="<?php echo (isset($golden) ? $golden['id'] : '0');?>" name="kind">
<table>
<tr><?php ShowHeader($account->kind);?></tr><tr>
<?php  for($i = 1; $i< 13;$i++)  {      printf('<td><input type="text" name = "t%d" value="%s" size="5"></td>',$i,isset($golden) ? $golden['t'.$i] : 0);  }  ?></tr><tr><td>X</td><td colspan="4"><input type="text" name="x" value="<?php echo (isset($golden) ? $golden['x'] : '0');?>"></td><td>Y</td><td colspan="4"><input type="text" name="y" value="<?php echo (isset($golden) ? $golden['y'] : '0');?>"></td>
    <td colspan="2"><input type="submit" value="<?php echo $lang['Save'];?>"></td></tr>

</table></form>
<form id ="edgc" action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid,$town->id,TROOP_GOLDEN_CLUB);?>" method="post">
    <input type="hidden" id="com" name="com" value="?">
    <input type="hidden" id ="kind" name="kind" value="?">
</form>
<form action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid,$town->id,TROOP_GOLDEN_CLUB);?>" method="post">
    <input type="hidden" id="com" name="com" value="<?php echo SEND_GOLDEN_CLUB;?>">
<?php  $sql = $dbo->ExectueQuery(sprintf('SELECT `g` . * , `t`.`name` FROM `%1$sgolden` AS `g` LEFT JOIN `%1$stown` AS `t` ON ( `g`.`tid2` = `t`.`id` ) WHERE `g`.`tid1` = \'%2$s\'',      DB_PERFIX,$town->id));  if($dbo->RowsNumber($sql))  {      $i = 0;      while($row = $dbo->Read($sql))      {          echo '<table>';          printf('<tr><td><input type="checkbox" name = "s%d" value="%s" /></td><td  colspan="3">%s</td><td colspan="4"><input type="button" value="%s" onclick="SetValues(\'com\',\'%s\');SubmitForm(\'edgc\',\'kind\',\'%s\');"/></td><td colspan="4"><input type="button" value="%s" onclick="SetValues(\'com\',\'%s\');SubmitForm(\'edgc\',\'kind\',\'%s\');"/></td></tr>',              $i,$row['id'],$lang['Send'],$lang['Edit'],CHANGE_GOLDEN_CLUB,$row['id'],$lang['Delete'],DEL_GOLDEN_CLUB,$row['id']);          printf('<tr><td>%s</td><td colspan="3">%s</td><td>X</td><td colspan="3">%s</td><td>Y</td><td colspan="3">%s</td></tr>',              $lang['Town'],$form->TownLink($row['tid2'],$row['name']),$row['x'],$row['y']);          ShowHeader($account->kind);          echo '<tr>';          for($j=1;$j<13;$j++)              printf('<td>%s</td>',$row['t'.$j]);          echo '<tr>';          echo '</table>';          $i++;      }  }  else      printf('<center>%s</center>',$lang['NoRecord']);  ?><center><input type="submit" value="<?php echo $lang['Send']; ?>" /> </center>
</form>
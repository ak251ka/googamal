<div class="b_troop">
<?php  require_once('.//lib/form.php');  require_once('.//lib/dbo.php');  require_once('.//lib/defines.php');  echo $lang['MarketElixir'];  $f = isset($_POST['kind'])? ValidNumber($_POST['kind'],true) : GET_TARGET;  $error = NO_ERROR;  if(isset($_POST['kind']) and ($_POST['kind'] = ValidNumber($_POST['kind'],true)))  {   $error = E_MARKET_NO_ELIXIR;   for($i=1;$i<16;$i++)   {    $e = 'e'.$i;    $_POST['tbes'.$i] = isset($_POST['tbes'.$i]) ? ValidNumber($_POST['tbes'.$i],true) : 0;    $_POST['tbes'.$i] = $_POST['tbes'.$i] > $town->$e ? $town->$e : $_POST['tbes'.$i];    if($_POST['tbes'.$i])     $error = NO_ERROR;   }   if($error)    $f = TARGET_NOT_VALID;   else   {    if(isset($_POST['tbName']) and !empty($_POST['tbName']))    {     $row  = $dbo->ExectueRow(sprintf('SELECT `id`,`mid` FROM `%stown` WHERE `name` = \'%s\'',      DB_PERFIX,$_POST['tbName']));     if(!empty($row))     {      $id = $row['id'];      $row  = $dbo->ExectueRow(sprintf('SELECT `x`,`y` FROM `%smap_t` WHERE `id` = \'%s\'',       DB_PERFIX,$row['mid']));      $_POST['tbX'] = $row['x'];      $_POST['tbY'] = $row['y'];     }     else      $id = 0;     }    else    {     $_POST['tbX'] = isset($_POST['tbX']) ? $_POST['tbX'] : 0;     $_POST['tbY'] = isset($_POST['tbY']) ? $_POST['tbY'] : 0;     $id = $dbo->ExectueScaler(sprintf('SELECT `subid` FROM `%smap_t` WHERE `x` = \'%s\' AND `y` = \'%s\' AND `kind` = \'%s\'',      DB_PERFIX,$_POST['tbX'],$_POST['tbY'], MAP_TOWN),'subid');    }    if(!$id)    {     $f = TARGET_NOT_VALID;     $error = E_TOWN_NOT_FIND;    }    else    {     if($id == $town->id)     {      $f = TARGET_NOT_VALID;      $error = E_SELF_SEND;     }     else      $row = $dbo->ExectueRow(       sprintf('SELECT `t`.`id` , `t`.`pid` , `t`.`name` AS `tname` , `a`.`name` AS `aname` FROM `%stown` AS `t` LEFT JOIN `%saccount` AS `a` ON ( `t`.`pid` = `a`.`id` ) WHERE `t`.`id` = \'%s\'',       DB_PERFIX, DB_PERFIX,$id));    }   }  }  if($f == SEND_VALID)  {   $temp = array();   for($i = 1;$i<15 ;$i++)   {    if($_POST['tbes'.$i])    {     $temp[$i] = $_POST['tbes'.$i];    }   }   if($town->SendElixir($id, $temp))    $report->SendElixir($account->id, $town->id,$town->mid, $id, $temp);   $f = TARGET_NOT_VALID;   $error = NO_ERROR;  }  if($f == TARGET_NOT_VALID)  {   switch($error)   {    case E_MARKET_NO_ELIXIR:     printf('<center><b>%s</b></center>',$lang['E_MARKET_NO_ELIXIR']);     break;    case E_SELF_SEND:     printf('<center><b>%s</b></center>',sprintf($lang['E_SELF_SEND'],$lang['Elixir']));     break;    case E_TOWN_NOT_FIND:     printf('<center><b>%s</b></center>',$lang['E_TOWN_NOT_FIND']);     break;    case NO_ERROR:     printf('<center><b>%s</b></center>',sprintf($lang['E_SEND_SUC'],$lang['Elixir']));     break;   }   $f = GET_TARGET;  }    ?>
<form action="<?php printf('building.php?bid=%s&amp;tid=%s&amp;show=%s',$bid, $town->id, MARKET);?>" method="post">
<input type = "hidden" name="com" value="<?php echo ELIXIR_MARKET;?>"  />
<input type="hidden" name="kind" value="<?php echo $f + 1;?>" />
<?php  if($f == GET_TARGET)  {   printf('<table><tr><td>%s</td><td><input type="text" value="" name="tbName" /></td></tr><tr><td>X</td><td><input type="text" value="0" name="tbX" /></td></tr><tr><td>Y</td><td><input type="text" value="0" name="tbY" /></td></tr><tr></tr></table>',$lang['Name']);   $j = 0;   printf('<table><tr><td>%s</td><td>%s</td><td>%s</td></tr>',$lang['Elixir'],$lang['Number'],$lang['Select']);   for($i = 1;$i<16;$i++)   {    $e = "e$i";    if($town->$e > 0)    {     printf('<tr><td><img src="img/eli/%d.gif" onclick="modal.Show(\'mo%d\');" alt="%s" class="i30s"  /></td><td><a href="javascript:void(0);" onclick="SetValues(\'tbes%d\',this.innerHTML);">%s</a></td><td><input type="text" value="0" name="tbes%d" id="tbes%d"  /></td></tr>',$i,$i, $list[$i]->name, $i, $town->$e, $i,$i);     $j++;    }   }   if(!$j)    printf('<tr><td colspan="3">%s</td></tr>',$lang['NoRecord']);   echo '</table>';   printf('<center><input type="submit" value="%s" /></center>', $lang['Send']);  }  elseif($f == CHECK_VALID)  {   printf('<table><tr><td>%s</td><td>%s</td></tr><tr><td>%s</td><td>%s</td></tr></table>',    $lang['Player'],$form->PlayerLink($row['pid'],$row['aname']),$lang['Town'],$form->TownLink($row['id'],$row['tname']));   printf('<table><tr><td>%s</td><td>%s</td></tr>',$lang['Elixir'],$lang['Number']);   $str = '';   for($i = 1;$i<16;$i++)   {    if($_POST['tbes'.$i])    {     printf('<tr><td><img src="img/eli/%d.gif" onclick="modal.Show(\'mo%d\');" alt="%s" class="i30s"  /></td><td>%d</td></tr>',$i,$i,$list[$i]->name,$_POST['tbes'.$i]);     $str .= sprintf('<input type="hidden" name="tbes%d" value="%d" />',$i,$_POST['tbes'.$i]);    }   }   printf('</table>');   echo $str;   printf('<center><input type="submit" value="%s" /></center>',$lang['Send']);   printf('<input type="hidden" name="tbX" value="%s"  /><input type="hidden" name="tbY" value="%s"  />',$_POST['tbX'],$_POST['tbY']);  }  ?>
</form>
</div>
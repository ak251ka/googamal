<?php  set_time_limit(0);  ini_set('memory_limit',"512M");  if(!defined('NEW_INCLUDE'))  {   $path = $_SERVER['DOCUMENT_ROOT'];   set_include_path(get_include_path() . PATH_SEPARATOR . $path);   define('NEW_INCLUDE', 1);  }  require_once('lib/config.php');  require_once('lib/defines.php');  require_once('lib/utility.php');  date_default_timezone_set(TIMEZONE);  function Medal($medal,$week,$point,$kind)  {      global $dbo;      $dbo->ExectueQuery('SET @prev_value = NULL;');      $dbo->ExectueQuery('SET @rank_count = 0;');      $dbo->ExectueQuery(sprintf('INSERT INTO `%1$smedal` (`owner`, `medal`, `kind`, `subkind`, `repeats`, `point`, `week`) SELECT `OWNER`, \'%3$s\', \'%4$s\',`rank`, \'1\',`%2$s`, \'%5$s\' FROM ( SELECT `OWNER`, `%2$s`, CASE WHEN @prev_value = `%2$s` THEN @rank_count WHEN @prev_value := `%2$s` THEN @rank_count := @rank_count + 1 END AS `rank` FROM `%1$spoint` WHERE `kind` = \'%4$s\' ORDER BY `%2$s` DESC) AS `tmp` WHERE `tmp`.`rank` < \'4\' AND `tmp`.`%2$s` > \'0\'',          DB_PERFIX,$point, $medal, $kind,$week));  }  function ExMedal($week,$kind)  {      global $dbo;      $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM (SELECT `owner`,`medal`,`subkind`,COUNT(*) AS `r` FROM `%1$smedal` WHERE `owner` IN ( SELECT `owner` FROM `%1$smedal` WHERE `week` = \'%3$d\' AND `kind` = \'%2$s\' ) AND `kind` = \'%2$s\' AND `repeats` = \'1\' GROUP BY `medal`, `subkind`) AS `m` WHERE `m`.`r` >= \'2\'',          DB_PERFIX,$kind,$week));        while($row = $dbo->Read($sql))      {          $point = $dbo->ExectueScaler(sprintf('SELECT `point` FROM `%smedal` WHERE `owner` = \'%s\' AND `kind` = \'%s\' AND `week` = \'%d\' LIMIT 1',              DB_PERFIX,$row['owner'],$kind,$week),'point');          if(($row['r'] % 2) == 0)              $dbo->ExectueQuery(sprintf('INSERT INTO `%smedal`(`owner`, `medal`, `kind`, `subkind`, `repeats`, `point`, `week`) VALUES (\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\');',                  DB_PERFIX,$row['owner'],$row['medal'],$kind,$row['subkind'],'2',                      $point,$week));          if(($row['r'] % 3) == 0)              $dbo->ExectueQuery(sprintf('INSERT INTO `%smedal`(`owner`, `medal`, `kind`, `subkind`, `repeats`, `point`, `week`) VALUES (\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\');',                  DB_PERFIX,$row['owner'],$row['medal'],$kind,$row['subkind'],'3',                  $point,$week));          if(($row['r'] % 5) == 0)              $dbo->ExectueQuery(sprintf('INSERT INTO `%smedal`(`owner`, `medal`, `kind`, `subkind`, `repeats`, `point`, `week`) VALUES (\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\');',                  DB_PERFIX,$row['owner'],$row['medal'],$kind,$row['subkind'],'4',                  $point,$week));          if(($row['r'] % 10) == 0)              $dbo->ExectueQuery(sprintf('INSERT INTO `%smedal`(`owner`, `medal`, `kind`, `subkind`, `repeats`, `point`, `week`) VALUES (\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\',\'%s\');',                  DB_PERFIX,$row['owner'],$row['medal'],$kind,$row['subkind'],'5',                 $point,$week));      }      $dbo->Cancel($sql);  }  $dbo->ExectueQuery(sprintf('UPDATE `%sserver_info` SET `kind` = \'%s\' WHERE `com` = \'%s\' AND `kind` != \'%s\' LIMIT 1',      DB_PERFIX, date('W'), SERVER_WEEK, date('W',time())));  if($dbo->AffectedRows())  {      $week = (int)abs(date('W') - date('W',$dbo->ExectueScaler(              sprintf('SELECT `kind` FROM `%sserver_info`',DB_PERFIX, LOG_IN_START),'kind')));      if($week <= 0)          $week = 1;      else          $week++;      Medal('1',$week,'pop',PLAYER_KIND);      Medal('2',$week,'plunder',PLAYER_KIND);      Medal('3',$week,'ap',PLAYER_KIND);      Medal('4',$week,'dp',PLAYER_KIND);      Medal('5',$week,'honor',PLAYER_KIND);        Medal('1',$week,'pop',UNION_KIND);      Medal('2',$week,'plunder',UNION_KIND);      Medal('3',$week,'ap',UNION_KIND);      Medal('4',$week,'dp',UNION_KIND);      Medal('5',$week,'honor',UNION_KIND);      ExMedal($week,PLAYER_KIND);      ExMedal($week,UNION_KIND);      $dbo->ExectueQuery(sprintf('UPDATE `%spoint` SET `ap`=\'0\',`dp`=\'0\',`pop`=\'0\',`plunder`=\'0\',`honor`=\'0\'',DB_PERFIX));  }    $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%ssession`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%slogtry`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%slogin`', DB_PERFIX));  $lWeek = (time()- (2*24*8*3600));  $dbo->ExectueQuery(sprintf('DELETE FROM `%spm` WHERE (`flag` & \'%1$u\' = \'%1$u\') OR (`flag` & \'%1$u\' = \'%1$u\')',DB_PERFIX,DEL_SENDER , DEL_RECIVER));  $dbo->ExectueQuery(sprintf('DELETE FROM `%sbuilding_q` WHERE `modify` < \'%s\' AND `d` = \'1\'', DB_PERFIX, $lWeek));  $dbo->ExectueQuery(sprintf('DELETE FROM `%selixir_e` WHERE `modify` < \'%s\' AND `d` = \'1\'', DB_PERFIX, $lWeek));  $dbo->ExectueQuery(sprintf('DELETE FROM `%stopic` WHERE `ac` = \'1\'', DB_PERFIX, $lWeek));  $dbo->ExectueQuery(sprintf('DELETE FROM `%stopic_p` WHERE `modify` < \'%s\' AND `ac` = \'1\'', DB_PERFIX, $lWeek));  $dbo->ExectueQuery(sprintf('DELETE FROM `%slogin` WHERE `modify` < \'%s\'', DB_PERFIX, $lWeek));  $dbo->ExectueQuery(sprintf('DELETE FROM `%shero_hs` WHERE `modify` < \'%s\'', DB_PERFIX, $lWeek));  $dbo->ExectueQuery(sprintf('DELETE FROM `%shero_ms` WHERE `modify` < \'%s\'', DB_PERFIX, $lWeek));    $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%spm`',DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%sbuilding_q`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%selixir_e`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%stown`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%sclooney`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%saccount`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%ssession`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%slogtry`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%slogin`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%shero_hs`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%shero_ms`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%stopic`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%stopic_m`', DB_PERFIX));  $dbo->ExectueQuery(sprintf('OPTIMIZE TABLE `%stopic_p`', DB_PERFIX));  ?>
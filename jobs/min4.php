<?php  set_time_limit(0);  ini_set('memory_limit',"512M");  gc_enable();  if(!defined('NEW_INCLUDE'))  {   $path = $_SERVER['DOCUMENT_ROOT'];   set_include_path(get_include_path() . PATH_SEPARATOR . $path);   define('NEW_INCLUDE', 1);  }  require_once('lib/config.php');  require_once('lib/defines.php');  require_once('lib/utility.php');  require_once('lib/dbo.php');  date_default_timezone_set(TIMEZONE);  function Lock($pid)  {   if(!$pid)    return true;   global $dbo;   $dbo->ExectueQuery(sprintf('UPDATE `%saccount` SET `locks` = \'1\' WHERE `id` = \'%s\' AND `locks` = \'0\' LIMIT 1',DB_PERFIX,$pid));   return $dbo->AffectedRows();  }  function UnLock($pid)  {   if(!$pid)    return;   global $dbo;   $dbo->ExectueQuery(sprintf('UPDATE `%saccount` SET `locks` = \'0\' WHERE `id` = \'%s\' LIMIT 1',DB_PERFIX,$pid));  }    function Plus($id,$money, $kind, $modify)  {      if(!$id)          return;      global $dbo;      $dbo->ExectueQuery(sprintf('UPDATE `%saccount` SET `m_b` = `m_b` + \'%s\' WHERE `id` = \'%s\' LIMIT 1',DB_PERFIX, $money, $id));      $arr = array();      $arr['pid'] =  $id;      $arr['cost'] = $money;      $arr['kind'] = $kind;      $arr['subkind'] = '1';      $arr['types'] =  INCOMMING;      $arr['modify'] = $modify;      $dbo->InsertRow(sprintf('%splus',DB_PERFIX), $arr);  }  $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM `%shero_hs` WHERE `modify` < \'%d\' AND `sol` = \'0\' AND `locks` = \'0\'',   DB_PERFIX, time()));  while($row = $dbo->Read($sql))  {   $p1 = Lock($row['p1']);   $p2 = Lock($row['p2']);   if( $p1 and $p2)   {    $dbo->ExectueQuery(sprintf('UPDATE `%shero_hs` SET `sol` = \'1\' WHERE `id` = \'%s\'', DB_PERFIX, $row['id']));    $dbo->ExectueQuery(sprintf('UPDATE `%shero_hi` SET `pid` = \'%s\', `box` = \'0\', `sel` = \'0\' WHERE `id` = \'%s\'',      DB_PERFIX,$row['p2'], $row['id']));    $dbo->ExectueQuery(sprintf('UPDATE `%shero_ms` SET `m1` = \'%s\' WHERE `id` = \'%s\' AND (`m1` = \'0\' OR `m1` > \'%s\')',      DB_PERFIX,$row['nb'], $row['mid'],$row['nb']));    $dbo->ExectueQuery(sprintf('UPDATE `%shero_ms` SET `m2` = \'%s\' WHERE `id` = \'%s\' AND `m2` < \'%s\'',      DB_PERFIX,$row['nb'], $row['mid'],$row['nb']));    Plus($row['p1'], $row['nb'], BUY_ITEM_H, $row['modify']);    Plus($row['p2'],$row['mb'] - $row['nb'], CANCEL_ITEM_H, $row['modify']);   }   if($p1)    UnLock($row['p1']);   if($p2)    UnLock($row['p2']);      gc_collect_cycles();  }  $dbo->Cancel($sql);  $command =$dbo->ExectueRow(sprintf('SELECT * FROM `%sserver_info` WHERE `com` = \'%s\'',      DB_PERFIX, SELL_ITEM));  if(empty($command))      return;  $modify =time() + (24 * ONE_TICK);  $today = Today($modify);  $arr = array();  for($i = $command['kind']; $i <= $command['subkind']; $i++)  {      $dbo->ExectueQuery(sprintf('INSERT INTO `%1$shero_ms` (`hid`, `modify`) SELECT * FROM (SELECT \'%2$s\', \'%3$s\') AS `tmp` WHERE NOT EXISTS ( SELECT `id` FROM `%1$shero_ms` WHERE `hid` = \'%2$s\' AND `modify` = \'%3$s\') LIMIT 1;',          DB_PERFIX, $i,$today));      $id = $dbo->ExectueScaler(sprintf('SELECT `id` FROM `%shero_ms` WHERE `hid` = \'%s\' and `modify` = \'%s\' LIMIT 1;',          DB_PERFIX, $i, $today),'id');      $t = $dbo->ExectueRow(sprintf('SELECT `t1`,`t4` FROM `%shero_i` WHERE `id` = \'%s\'',DB_PERFIX,$i));      $arr['hid'] = $i;      $arr['t1'] = $t['t1'];      $arr['mid'] = $id;      $arr['nb'] = ($t['t4'] ? EXCHANGE_T: EXCHANGE_M);      $arr['mb'] = $arr['nb'];      $arr['modify'] = $modify;      for($j=0; $j < MAX_SELL_WEAPON; $j++)          $dbo->InsertRow(DB_PERFIX.'hero_hs', $arr);      gc_collect_cycles();  }  ?>
<?php  if(empty($_POST))   return;  if(!defined('NEW_INCLUDE'))  {   $path = $_SERVER['DOCUMENT_ROOT'];   set_include_path(get_include_path() . PATH_SEPARATOR . $path);   define('NEW_INCLUDE', 1);  }  require_once('lib/defines.php');  require_once('lib/config.php');  require_once('lib/dbo.php');  require_once('lib/utility.php');  require_once('eng/sec/session.php');  require_once('eng/main/union.php');  require_once('lng/per.php');  if($session->GetType() != LOG)  {   echo json_encode('LOG');   return;  }  else  {   $uid = $dbo->ExectueScaler(sprintf('SELECT `uid` FROM `%sunion_m` WHERE `pid` = \'%s\' LIMIT 1',     DB_PERFIX, $session->aid),'uid');   if($session->aid != $session->pid or !$uid)          echo json_encode('PERMISSION');   else   {      $_POST['kind'] = isset($_POST['kind'])? ValidNumber($_POST['kind'],true) : 0;    $_POST['subkind'] = isset($_POST['subkind'])? ValidNumber($_POST['subkind'],true): 0;    $isOfficer = $union->IsOfficer($uid, $session->aid);    if($_POST['kind'] and $_POST['subkind'] and $isOfficer)    {     switch($_POST['kind'])     {      case 1:       if(!($isOfficer &SET_RANK_UNION) or !$union->IsMember($uid,$_POST['subkind']))       {                          echo json_encode('PERMISSION');        break;       }       $name = $dbo->ExectueScaler(sprintf('SELECT `name` FROM `%saccount` WHERE `id` = \'%u\'',DB_PERFIX,$_POST['subkind']), 'name');       if(empty($name))       {                          echo json_encode('PERMISSION');        break;       }                      $name =  htmlspecialchars($name);                      $arr = array();       $off = $dbo->ExectueRow(sprintf('SELECT * FROM `%sunion_o` WHERE `uid` = \'%s\' AND `pid` = \'%u\'',        DB_PERFIX, $uid,  $_POST['subkind']));       if(empty($off))                      {                          echo json_encode(1).'<r>';                          echo $name.'<r>';                          echo json_encode($_POST['subkind']).'<r>';                          echo '<r>';                          echo  json_encode(0).'<r>';                          echo  json_encode(0).'<r>';                          echo  json_encode(0).'<r>';                          echo  json_encode(0);                      }         else       {                          echo json_encode(1).'<r>';                          echo $name.'<r>';                          echo json_encode($_POST['subkind']).'<r>';                          echo $off['job'].'<r>';                          echo json_encode(($off['permission'] & INVITE_UNION) ? 1: 0).'<r>';                          echo json_encode(($off['permission'] & SET_RANK_UNION) ? 1: 0).'<r>';                          echo json_encode(($off['permission'] & EDIT_FROM) ? 1: 0).'<r>';                          echo json_encode(($off['permission'] & UNION_POLICY) ? 1: 0);       }       break;      case 2:       if(!($isOfficer &SET_RANK_UNION))       {                          echo json_encode('PERMISSION');        break;       }       $dbo->ExectueQuery(        sprintf('UPDATE `%sunion_m` SET `rank` = `rank` + \'1\' WHERE `id` = \'%u\' AND `uid` = \'%s\'  AND `rank` < \'11\' LIMIT 1',        DB_PERFIX, $_POST['subkind'], $uid));       $t = $dbo->ExectueScaler(sprintf('SELECT `rank` FROM `%sunion_m` WHERE `id` =  \'%u\' AND `uid` = \'%s\' LIMIT 1',         DB_PERFIX, $_POST['subkind'], $uid),'rank');       if($t)                      {                          echo json_encode(2).'<r>';                          echo json_encode($_POST['subkind']).'<r>';                          echo $lang['U_R_'.$t];                      }       else                          echo json_encode('PERMISSION');       break;      case 3:       if(!($isOfficer &SET_RANK_UNION))       {                          echo json_encode('PERMISSION');        break;       }       $dbo->ExectueQuery(        sprintf('UPDATE `%sunion_m` SET `rank` = `rank` - \'1\' WHERE `id` = \'%u\' AND `uid` = \'%s\'  AND `rank` > \'1\' LIMIT 1',        DB_PERFIX, $_POST['subkind'], $uid));       $t = $dbo->ExectueScaler(sprintf('SELECT `rank` FROM `%sunion_m` WHERE `id` =  \'%u\' AND `uid` = \'%s\' LIMIT 1',         DB_PERFIX, $_POST['subkind'], $uid),'rank');              if($t)                      {                          echo json_encode('3').'<r>';                          echo json_encode($_POST['subkind']).'<r>';                          echo $lang['U_R_'.$t];                      }       else                          echo json_encode('PERMISSION');       break;      case 4:       if(!($isOfficer &SET_RANK_UNION) or !$union->IsMember($uid,$_POST['subkind']))       {                          echo json_encode('PERMISSION');        break;       }       $arr = array();       $arr['uid'] = $uid;       $arr['pid'] = $_POST['subkind'];       $arr['job'] = isset($_POST['job']) ? mb_substr($_POST['job'],0,32,'utf-8') : $lang['Unknown'];       $arr['permission'] = isset($_POST['permission']) ? ValidNumber($_POST['permission'],true) : '0';       if($arr['permission']> 15)        $arr['permission'] = '15';       $oid = $dbo->ExectueScaler(sprintf('SELECT `id` FROM `%sunion_o` WHERE `uid` = \'%s\' AND `pid` = \'%u\' LIMIT 1',        DB_PERFIX,$uid,$_POST['subkind']),'id');       if($oid)        $dbo->UpdateRow(DB_PERFIX.'union_o', $arr, $oid);       else        $dbo->InsertRow(DB_PERFIX.'union_o', $arr);                      $name = $dbo->ExectueScaler(sprintf('SELECT `name` FROM `%saccount` WHERE `id` = \'%u\'',DB_PERFIX,$_POST['subkind']), 'name');                      if(empty($name))                      {                          echo json_encode('PERMISSION');                          break;                      }                      $name =  htmlspecialchars($name);                      $off = $dbo->ExectueRow(sprintf('SELECT * FROM `%sunion_o` WHERE `uid` = \'%s\' AND `pid` = \'%u\'',                          DB_PERFIX, $uid,  $_POST['subkind']));                      echo json_encode(1).'<r>';                      echo $name.'<r>';                      echo json_encode($_POST['subkind']).'<r>';                      echo $off['job'].'<r>';                      echo json_encode(($off['permission'] & INVITE_UNION) ? 1: 0).'<r>';                      echo json_encode(($off['permission'] & SET_RANK_UNION) ? 1: 0).'<r>';                      echo json_encode(($off['permission'] & EDIT_FROM) ? 1: 0).'<r>';                      echo json_encode(($off['permission'] & UNION_POLICY) ? 1: 0);       break;      case 5:       $off = $union->IsOfficer($uid, $_POST['subkind']);       if(!($isOfficer &SET_RANK_UNION))       {                          echo json_encode('PERMISSION');        break;       }       $dbo->ExectueQuery(sprintf('DELETE FROM `%sunion_o` WHERE `uid` = \'%s\' AND `pid` = \'%u\' LIMIT 1',        DB_PERFIX,$uid,$_POST['subkind']));       break;      case 6:       if(!($isOfficer &SET_RANK_UNION) or !$union->IsMember($uid,$_POST['subkind']))       {                          echo json_encode('PERMISSION');        break;       }       $union->Fire($uid, $session->aid, $_POST['subkind']);                      echo json_encode(1).'<r>';                      echo json_encode($_POST['subkind']);       break;     }    }    else     echo json_encode('PERMISSION');   }  }  $session->Save();  ?>
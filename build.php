<?php  require_once('lib/config.php');  require_once('lib/dbo.php');  require_once('lib/object.php');  require_once('eng/sec/session.php');  require_once('lib/form.php');  require_once('eng/conn/pm.php');  require_once('eng/main/account.php');  require_once('eng/main/plus.php');  require_once('lib/defines.php');  require_once('lib/utility.php');  require_once('eng/main/hero.php');  require_once('eng/main/union.php');  if(!$session->IsLoad() or $session->GetType() != LOG)   $session->Href('index.php');     $account = new Account($session->aid,true);  if(!$account->IsLoad())   $session->Href('index.php');    $account->UpdateTown($_SERVER['REQUEST_TIME']);  if(!$account->ac)      $session->Href('index.php');  $plus = $account->GetPlus();  $hero = $account->GetHero();  if(isset($_GET['tid']))   $account->SwitchTown($_GET['tid']);  $town = $account->GetDefaultTown();  $sid = isset($_GET['sid']) ? ValidNumber($_GET['sid']) : 0;  if(!$sid)   $session->Href('town.php');  $b = "b$sid";  if($town->$b)   $session->Href('town.php');  if($session->Permission(BAND_TOWN))  {      if(isset($_POST['com']) and $_POST['com'] == 'nb')      {          if($town->Lock())          {              $_POST['kind'] = isset($_POST['kind']) ? ValidNumber($_POST['kind'],true): 0;              if($_POST['kind'])              {                  if($_POST['kind'] < 7 or $_POST['kind'] == 26 or $_POST['kind'] == 27)                      $_POST['sid'] = $_POST['kind'];                  else                      $_POST['sid'] = ValidNumber($_POST['sid'],true);                    $b = 'b'.$_POST['sid'];                    if(!$_POST['sid'] or $town->$b)                  {                      $town->UnLock();                      $session->Href('town.php');                  }                  $row = $dbo->ExectueRow(sprintf('SELECT `lvl`,`mb` FROM `%sbuilding_i` WHERE `id` = \'%s\'',DB_PERFIX,                      $_POST['kind']));                    $lvl = $town->GetLevel($_POST['kind']);                  if($lvl != -1 and !$row['mb'])                  {                      $town->UnLock();                      $session->Href('town.php');                  }                  elseif($lvl != -1)                  {                      $lvl = 0;                      for($i= 1;$i < 28; $i++)                      {                          $tb = 'b'.$i;                          $tu = 'u'.$i;                          if($town->$tb == $_POST['kind'] and $town->$tu == $row['lvl'])                          {                              $lvl = $row['lvl'];                              break;                          }                      }                      if(!$lvl)                      {                          $town->UnLock();                          $session->Href('town.php');                      }                  }                  $arr = array();                  $arr[$b] =  $_POST['kind'];                  if($town->BuildBuilding($_POST['sid'],$_POST['kind'], '1', $plus->HavePlus('pb')))                      $dbo->UpdateRow(DB_PERFIX.'town',$arr, $town->id);                  $town->UnLock();                  $session->Href('town.php');              }          }          else              $session->Href('town.php');      }  }      $pm = new PM($session->aid);  $union = new Union();  $sql = $dbo->ExectueQuery(sprintf('SELECT * FROM `%1$sbuilding_d` As `d` LEFT JOIN `%1$sbuilding_i`AS `i` ON (`d`.`bid` = `i`.`id`) WHERE `d`.`lvl` = \'1\'',   DB_PERFIX));  $list = array();  $i = 0;  $requirement = array();    $requirement[1 ] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[2 ] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[3 ] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[4 ] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[5 ] = array(0,0,0,0,0,0,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[6 ] = array(0,0,0,0,0,0,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[7 ] = array(0,0,0,0,0,2,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[8 ] = array(0,0,0,0,0,2,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[9 ] = array(0,0,0,0,0,3,1,1,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[10] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[11] = array(0,0,0,0,0,3,0,0,0,0  ,0,0,0,0,0,0,0,0,1,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[12] = array(0,0,0,0,0,3,0,0,0,0  ,3,0,0,0,0,0,0,1,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[13] = array(0,0,0,0,0,5,0,0,0,0  ,3,1,0,0,0,0,0,3,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[14] = array(0,0,0,0,0,5,0,0,0,0  ,5,0,0,0,0,0,3,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[15] = array(0,0,0,0,0,10,0,0,0,0  ,0,0,0,0,0,0,10,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[16] = array(0,0,0,0,0,10,0,0,0,0  ,10,0,0,0,0,0,10,0,5,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[17] = array(0,0,0,0,0,5,0,0,0,0  ,0,0,0,0,0,0,0,5,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[18] = array(0,0,0,0,0,3,0,0,0,0  ,3,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[19] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[20] = array(0,0,0,0,0,3,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[21] = array(0,0,0,0,0,3,0,0,0,0  ,0,0,0,0,0,0,0,0,0,1 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[22] = array(0,0,0,0,0,10,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[23] = array(0,0,0,0,0,10,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,1,0,0,0,0,0,0,0,0, 0,0);  $requirement[24] = array(0,0,0,0,0,3,0,0,0,0  ,0,0,0,0,0,0,0,0,0,1 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[25] = array(0,0,0,0,0,15,0,0,0,0  ,0,0,0,0,0,0,0,0,20,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[26] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[27] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,10,0,0,0,0, 0,0);  $requirement[28] = array(0,0,0,0,0,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[29] = array(0,0,0,0,10,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[30] = array(0,0,0,0,15,1,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[31] = array(0,0,0,0,0,5,0,0,0,0  ,0,0,0,0,0,0,0,0,5,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $requirement[32] = array(0,0,0,0,0,10,0,0,0,0  ,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,0,0,0,0, 0,0);  $form->Header(array('build'),array());    function RequireMents($bid)  {   global $lang;   global $town;   global $requirement;   $arr = array(0 =>true, 1=>array());   for($i = 0;$i<32;$i++)   {    if($requirement[$bid][$i])    {     if($town->GetLevel($i + 1) >= $requirement[$bid][$i])      $arr[1][] = '<b>'.sprintf($lang['BuildingInfo'],$lang['b'.($i+1)],$requirement[$bid][$i]).'</b><br />';     else     {      $arr[1][] = '<strike>'.sprintf($lang['BuildingInfo'],$lang['b'.($i+1)],$requirement[$bid][$i]).'</strike><br />';      $arr[0] = false;     }    }   }   if((count($arr[1]) == 0) and $arr[0])    $arr[1][] = '-';   return $arr;  }  while($row = $dbo->Read($sql))  {   $lvl = $town->GetLevel($row['id']);   if( $lvl == -1)   {    $list[$row['id']] = new Object($row);    $list[$row['id']]->name = $lang['b'.$row['id']];    $list[$row['id']]->req = RequireMents($row['id']);   }   elseif($row['mb'])   {    for($i=1; $i < 28; $i++)    {     $b = "b$i";     $u = "u$i";     if($town->$b == $row['id'])     {      if($lvl < $town->$u)       $lvl = $town->$u;     }    }    if($lvl == $row['lvl'])    {     $list[$row['id']] = new Object($row);     $list[$row['id']]->name = $lang['b'.$row['id']];     $list[$row['id']]->req = RequireMents($row['id']);    }   }  }  if(!$town->won)   unset($list[32]);    $dbo->Cancel($sql);  $count = $town->CountBuild();  $fix =  array(1,2,3,4,5,6,26,27);  if($town->won)   $fix[8] = 32;  ?>
<div class="h56">
<img src="img/m0.png"  />
</div>
<div class="bgm1">
<?php  if($session->Permission(BAND_TOWN))  {  ?>
    <form action="<?php printf('build.php?tid=%s&amp;sid=%s',$town->id,$sid);?>" method="post">
    <input type="hidden" name = "com" value="nb" />
    <input type="hidden" name="sid" value="<?php echo $sid;?>" />
    <input type="hidden" name="kind" id="kind" value="?" />
    <table class="b_table">
        <tr><td><?php echo $lang['Building'];?></td><td><?php echo $lang['Name'];?></td><td><?php echo $lang['Description'];?></td><td><?php echo $lang['Requirement'];?></td></tr>
<?php                if(in_array( $sid,$fix))              {                  printf('<tr><td class = "b_tabletd1"><img src="img/tow/big/b%s.gif" alt="%s" class="bBigImg"/></td><td class="b_b_name">%s</td><td class="b_desc">%s',                      $list[$sid]->id,$list[$sid]->name,$list[$sid]->name,$list[$sid]->description);                  echo('<br/><div class="b_s_font">');                  $form->EchoCost($list[$sid]->r1,$list[$sid]->r2,$list[$sid]->r3,$list[$sid]->r4,$list[$sid]->r5,                      SecToString($town->BuildSpeed($list[$sid]->id,$list[$sid]->times)),$list[$sid]->pop);                  echo('</div><br/>');                  if($count and !$plus->HavePlus('pb'))                      printf($lang['MaxPermission'], $lang['Build']);                  elseif($count == 2)                      printf($lang['MaxPermission'], $lang['Build']);                  elseif($town->Frozen())                      echo $lang['FrozenTown'];                  elseif(!$town->CanBuild($list[$sid]->pop) and ($sid != 6) and $town->cap)                      echo $lang['NotEnoughGold'];                  elseif($town->l1 < $list[$sid]->r1 or $town->l1 < $list[$sid]->r2 or $town->l1 < $list[$sid]->r3 or $town->l1 < $list[$sid]->r4)                      printf($lang['NotEnough'],$lang['b7']);                  elseif($town->l1 < $list[$sid]->r5)                      printf($lang['NotEnough'],$lang['b8']);                  elseif(!$town->HaveEnough($list[$sid]->r1,$list[$sid]->r2,$list[$sid]->r3,$list[$sid]->r4,$list[$sid]->r5))                      printf($lang['NotEnough'],$lang['Resource']);                  elseif(!$list[$sid]->req[0])                      echo $lang['NoRequirement'];                  else                      printf('<center><input type="submit" value="%s" onclick="SetValues(\'kind\',\'%s\');" /></center>',$lang['Build'],$list[$sid]->id);                  printf('</td><td class="b_req">%s</td></tr>',implode('<br />',$list[$sid]->req[1]));              }              else              {                  foreach($list as $l)                  {                      if(in_array($l->id,$fix))                          continue;                      printf('<tr><td  class = "b_tabletd1"><img src="img/tow/big/b%s.gif" alt="%s" class="bBigImg"/></td><td class="b_b_name">%s</td><td class="b_desc">%s',                          $l->id,$l->name,$l->name,$l->description);                      echo('<br/><div class="b_s_font">');                      $form->EchoCost($l->r1,$l->r2,$l->r3,$l->r4,$l->r5,SecToString($town->BuildSpeed($l->id,$l->times)),$l->pop);                      echo('</div><br/>');                      if($count and !$plus->HavePlus('pb'))                          printf($lang['MaxPermission'], $lang['Build']);                      elseif($count == 2)                          printf($lang['MaxPermission'], $lang['Build']);                      elseif($town->Frozen())                          echo $lang['FrozenTown'];                      elseif(!$town->CanBuild($l->pop))                          echo $lang['NotEnoughGold'];                      elseif($town->l1 < $l->r1 or $town->l1 < $l->r2 or $town->l1 < $l->r3 or $town->l1 < $l->r4)                          printf($lang['NotEnough'],$lang['b7']);                      elseif($town->l1 < $l->r5)                          printf($lang['NotEnough'],$lang['b8']);                      elseif(!$town->HaveEnough($l->r1,$l->r2,$l->r3,$l->r4,$l->r5))                          printf($lang['NotEnough'],$lang['Resource']);                      elseif(!$l->req[0])                          echo $lang['NoRequirement'];                      else                          printf('<center><input type="submit" value="%s" onclick="SetValues(\'kind\',\'%s\');" /></center>',$lang['Build'],$l->id);                      printf('</td><td class="b_req">%s</td></tr>',implode('<br />',$l->req[1]));                  }              }              ?>
        </table>
    </form>
<?php  }  else      $form->BlockPage();  ?>
</div>
<div class="h56"><img src="img/m2.png"  /></div>
<?php  $form->Footer();  $session->Save();  ?>